<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.7.1">
<meta name="description" content="A training course for Clojure.">
<meta name="keywords" content="enterprise Clojure training">
<meta name="author" content="Timothy Pratley">
<meta name="copyright" content="Timothy Pratley">
<title>Enterprise Clojure Training</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote::before{display:none}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{word-spacing:0;line-height:1.6}
.quoteblock.abstract blockquote::before,.quoteblock.abstract p::before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="shortcut icon" type="image/x-icon" href="img/clojure-logo-icon-32.png">
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Enterprise Clojure Training</h1>
<div class="details">
<span id="author" class="author">Timothy Pratley</span><br>
<span id="email" class="email">&lt;<a href="mailto:timothypratley@gmail.com">timothypratley@gmail.com</a>&gt;</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_about">About</a>
<ul class="sectlevel2">
<li><a href="#_overview">Overview</a></li>
<li><a href="#_duration">Duration</a></li>
<li><a href="#_learning_objectives">Learning Objectives</a></li>
<li><a href="#_prerequisites">Prerequisites</a></li>
<li><a href="#_target_audience">Target Audience</a></li>
<li><a href="#_required_setup">Required setup</a></li>
<li><a href="#_pre_assessment">Pre-assessment</a></li>
<li><a href="#_required_preparation">Required preparation</a></li>
<li><a href="#_optional_reading">Optional reading</a></li>
<li><a href="#_introductions">Introductions</a>
<ul class="sectlevel3">
<li><a href="#_the_instructor">The instructor</a></li>
<li><a href="#_clojure">Clojure</a></li>
<li><a href="#_syntax_summary">Syntax Summary</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_the_clojure_ecosystem">1. The Clojure Ecosystem</a>
<ul class="sectlevel2">
<li><a href="#_leiningen">1.1. Leiningen</a></li>
<li><a href="#_the_read_eval_print_loop_repl">1.2. The Read Eval Print Loop (REPL)</a></li>
<li><a href="#_editor_setup">1.3. Editor setup</a></li>
<li><a href="#_exercises">1.4. Exercises</a></li>
<li><a href="#_answers">1.5. Answers</a></li>
</ul>
</li>
<li><a href="#_clojure_syntax">2. Clojure Syntax</a>
<ul class="sectlevel2">
<li><a href="#_primitive_data_types">2.1. Primitive data types</a></li>
<li><a href="#_collections_lists_vectors_maps_and_sets">2.2. Collections: lists, vectors, maps, and sets</a></li>
<li><a href="#_invoking_functions">2.3. Invoking functions</a></li>
<li><a href="#_defining_vars">2.4. Defining vars</a></li>
<li><a href="#_binding_names_with_let">2.5. Binding names with let</a></li>
<li><a href="#_destructuring_also_known_as_binding_forms">2.6. Destructuring (also known as binding forms)</a></li>
<li><a href="#_namespaces">2.7. Namespaces</a></li>
<li><a href="#_regex">2.8. Regex</a></li>
<li><a href="#_exercises_2">2.9. Exercises</a></li>
<li><a href="#_answers_2">2.10. Answers</a></li>
</ul>
</li>
<li><a href="#_functions_2">3. Functions</a>
<ul class="sectlevel2">
<li><a href="#_defining_functions">3.1. Defining functions</a></li>
<li><a href="#_pre_and_post_conditions">3.2. Pre- and post-conditions</a></li>
<li><a href="#_anonymous_functions">3.3. Anonymous functions</a></li>
<li><a href="#_function_literals">3.4. Function literals</a></li>
<li><a href="#_keyword_and_variadic_arguments">3.5. Keyword and variadic arguments</a></li>
<li><a href="#_exercises_3">3.6. Exercises</a></li>
<li><a href="#_answers_3">3.7. Answers</a></li>
</ul>
</li>
<li><a href="#_challenge_1_corgi_cover_eligibility">Challenge 1: Corgi Cover eligibility</a>
<ul class="sectlevel2">
<li><a href="#_part_1">Part 1:</a>
<ul class="sectlevel3">
<li><a href="#_test_data">Test data:</a></li>
</ul>
</li>
<li><a href="#_part_2">Part 2:</a></li>
<li><a href="#_part_3">Part 3:</a></li>
<li><a href="#_part_4">Part 4:</a></li>
</ul>
</li>
<li><a href="#_testing_with_clojure_test">4. Testing with clojure.test</a>
<ul class="sectlevel2">
<li><a href="#_defining_tests_with_deftest">4.1. Defining tests with deftest</a></li>
<li><a href="#_lein_test_refresh">4.2. lein-test-refresh</a></li>
<li><a href="#_assertions_with_is_and_are">4.3. Assertions with is and are</a></li>
<li><a href="#_test_fixtures">4.4. Test fixtures</a></li>
<li><a href="#_using_with_redefs_for_mocking_behavior">4.5. Using with-redefs for mocking behavior</a></li>
<li><a href="#_debugging">4.6. Debugging</a></li>
<li><a href="#_exercises_4">4.7. Exercises</a></li>
<li><a href="#_answers_4">4.8. Answers</a></li>
</ul>
</li>
<li><a href="#_control_flow">5. Control Flow</a>
<ul class="sectlevel2">
<li><a href="#_conditionals_if_when_cond">5.1. Conditionals: if, when, cond</a></li>
<li><a href="#_recursion">5.2. Recursion</a></li>
<li><a href="#_loops">5.3. Loops</a></li>
<li><a href="#_exception_handling">5.4. Exception handling</a></li>
<li><a href="#_comments">5.5. Comments</a></li>
<li><a href="#_exercises_5">5.6. Exercises</a></li>
<li><a href="#_answers_5">5.7. Answers</a></li>
</ul>
</li>
<li><a href="#_functional_programming">6. Functional Programming</a>
<ul class="sectlevel2">
<li><a href="#_pure_functions_and_side_effects">6.1. Pure functions and side effects</a></li>
<li><a href="#_apply_partial_and_comp">6.2. Apply, partial, and comp</a></li>
<li><a href="#_functions_on_sequences_map_reduce_and_friends">6.3. Functions on sequences: map, reduce, and friends</a></li>
<li><a href="#_threading_operators">6.4. Threading operators</a></li>
<li><a href="#_data_structures_are_functions">6.5. Data structures are functions!</a></li>
<li><a href="#_exercises_6">6.6. Exercises</a></li>
<li><a href="#_answers_6">6.7. Answers</a></li>
</ul>
</li>
<li><a href="#_challenge_2_processing_files">Challenge 2: Processing files</a>
<ul class="sectlevel2">
<li><a href="#_part_1_2">Part 1:</a></li>
<li><a href="#_part_2_2">Part 2:</a></li>
<li><a href="#_part_3_2">Part 3:</a></li>
<li><a href="#_part_4_2">Part 4:</a></li>
</ul>
</li>
<li><a href="#_macros">7. Macros</a>
<ul class="sectlevel2">
<li><a href="#_expanding_macros">7.1. Expanding macros</a></li>
<li><a href="#_defining_macros">7.2. Defining macros</a></li>
<li><a href="#_syntax_quoting">7.3. Syntax quoting</a></li>
<li><a href="#_code_as_data">7.4. Code as data</a></li>
<li><a href="#_exercises_7">7.5. Exercises</a></li>
<li><a href="#_answers_7">7.6. Answers</a></li>
</ul>
</li>
<li><a href="#_parallel_programming_and_concurrency">8. Parallel Programming and Concurrency</a>
<ul class="sectlevel2">
<li><a href="#_vars_and_dynamic_scope">8.1. Vars and dynamic scope</a></li>
<li><a href="#_delays_futures_and_promises">8.2. Delays, Futures, and Promises</a>
<ul class="sectlevel3">
<li><a href="#_delays">8.2.1. Delays</a></li>
<li><a href="#_futures">8.2.2. Futures</a></li>
<li><a href="#_promises">8.2.3. Promises</a></li>
</ul>
</li>
<li><a href="#_atoms_refs_and_agents">8.3. Atoms, Refs, and Agents</a></li>
</ul>
</li>
<li><a href="#_java_interop">9. Java Interop</a>
<ul class="sectlevel2">
<li><a href="#_clojure_syntax_for_java_constructors">9.1. Clojure syntax for Java constructors</a></li>
<li><a href="#_calling_methods">9.2. Calling methods</a></li>
<li><a href="#_reify">9.3. reify</a></li>
<li><a href="#_gen_class_and_proxy">9.4. gen-class and proxy</a></li>
<li><a href="#_including_java_classes_in_clojure_projects">9.5. Including Java classes in Clojure projects</a></li>
</ul>
</li>
<li><a href="#_challenge_3_mocking_parallel_web_requests">10. Challenge 3: Mocking parallel web requests</a>
<ul class="sectlevel2">
<li><a href="#_part_1_mock_a_web_request">10.1. Part 1: Mock a web request</a></li>
<li><a href="#_part_2_report_the_how_long_it_takes">10.2. Part 2: Report the how long it takes</a></li>
<li><a href="#_part_3_make_parallel_requests">10.3. Part 3: Make parallel requests</a></li>
<li><a href="#_part_4_error_handling">10.4. Part 4: Error handling</a></li>
</ul>
</li>
<li><a href="#_polymorphism_and_types">11. Polymorphism and Types</a>
<ul class="sectlevel2">
<li><a href="#_multimethods">11.1. Multimethods</a></li>
<li><a href="#_protocols">11.2. Protocols</a></li>
<li><a href="#_creating_types_with_defrecord_and_deftype">11.3. Creating types with defrecord and deftype</a>
<ul class="sectlevel3">
<li><a href="#_deftype">11.3.1. Deftype</a></li>
<li><a href="#_defrecord">11.3.2. Defrecord</a></li>
</ul>
</li>
<li><a href="#_specifications_with_clojure_spec">11.4. Specifications with clojure.spec</a></li>
<li><a href="#_validation">11.5. Validation</a></li>
<li><a href="#_conforming">11.6. Conforming</a></li>
<li><a href="#_maps">11.7. Maps</a></li>
<li><a href="#_a_game_of_cards">11.8. A game of cards</a></li>
<li><a href="#_generators">11.9. Generators</a></li>
<li><a href="#_instrumentation_and_testing">11.10. Instrumentation and Testing</a></li>
</ul>
</li>
<li><a href="#_interacting_with_a_database">12. Interacting with a Database</a>
<ul class="sectlevel2">
<li><a href="#_intro_to_clojure_java_jdbc">12.1. Intro to clojure.java.jdbc</a></li>
<li><a href="#_inserting_updating_and_retrieving_data">12.2. Inserting, updating and retrieving data</a></li>
<li><a href="#_solutions_for_sql_management">12.3. Solutions for SQL management</a></li>
<li><a href="#_exercises_8">12.4. Exercises</a></li>
<li><a href="#_answers_8">12.5. Answers</a></li>
</ul>
</li>
<li><a href="#_challenge_4_corgi_cover_database">Challenge 4: Corgi Cover Database</a>
<ul class="sectlevel2">
<li><a href="#_part_1_set_up_the_schema">Part 1: Set up the schema</a></li>
<li><a href="#_part_2_populate_the_data">Part 2: Populate the data</a></li>
<li><a href="#_part_3_write_a_spec">Part 3: Write a spec</a></li>
<li><a href="#_part_4_extending_to_poodle_protection">Part 4: Extending to Poodle Protection</a></li>
</ul>
</li>
<li><a href="#_further_reading">13. Further reading</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_about">About</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Welcome to Enterprise Clojure Training.
This course is for developers learning Clojure for the purpose of building enterprise software.</p>
</div>
<div class="sect2">
<h3 id="_overview">Overview</h3>
<div class="paragraph">
<p>Clojure is a dynamic, general-purpose programming language, combining interactive development with an efficient and robust infrastructure for multithreaded programming.
Clojure provides direct access to the Java frameworks.
Clojure is a dialect of Lisp, and shares with Lisp the code-as-data philosophy and macro system.
Clojure is predominantly a functional programming language, and features a rich set of immutable, persistent data structures.</p>
</div>
<div class="paragraph">
<p>In this course we will cover how to:
  install Clojure and related tools;
  interact with Clojure via the read-eval-print- loop (REPL);
  create functions, data-structures, macros, and types;
  use functional programming constructs like map and reduce;
  and design, implement, and test Clojure programs.</p>
</div>
<div class="paragraph">
<p>Each section will feature interactive exercises, and course material will be reinforced with guided case studies.</p>
</div>
</div>
<div class="sect2">
<h3 id="_duration">Duration</h3>
<div class="paragraph">
<p>2days, 10 hr/day + 2 hour webinar after completion of workshop.</p>
</div>
</div>
<div class="sect2">
<h3 id="_learning_objectives">Learning Objectives</h3>
<div class="paragraph">
<p>At the end of this course, you will be able to</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Write Clojure code</p>
</li>
<li>
<p>Structure Clojure products</p>
</li>
<li>
<p>Interact with Java</p>
</li>
<li>
<p>Use Clojure&#8217;s parallel programming and concurrency facilities</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_prerequisites">Prerequisites</h3>
<div class="paragraph">
<p>General programming knowledge.</p>
</div>
</div>
<div class="sect2">
<h3 id="_target_audience">Target Audience</h3>
<div class="paragraph">
<p>Developers and Senior Developers.</p>
</div>
</div>
<div class="sect2">
<h3 id="_required_setup">Required setup</h3>
<div class="paragraph">
<p>The following software must be installed on your laptop prior to the course:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Java (<a href="https://java.com" class="bare">https://java.com</a>)</p>
</li>
<li>
<p>Leiningen	(<a href="https://leiningen.org" class="bare">https://leiningen.org</a>)</p>
</li>
<li>
<p>IntelliJ (<a href="https://www.jetbrains.com/idea" class="bare">https://www.jetbrains.com/idea</a>)</p>
</li>
<li>
<p>Cursive plugin for IntelliJ (<a href="https://cursive-ide.com" class="bare">https://cursive-ide.com</a>)</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_pre_assessment">Pre-assessment</h3>
<div class="ulist">
<ul>
<li>
<p>What programming languages have you used before?</p>
</li>
<li>
<p>Do you have an interest in Clojure? If so what in particular interests you?</p>
</li>
<li>
<p>What do you plan to do with Clojure?</p>
</li>
<li>
<p>Name a scenario where you would use a HashMap data structure.</p>
</li>
<li>
<p>When should you use a Vector instead of a List or an Array?</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_required_preparation">Required preparation</h3>
<div class="paragraph">
<p>Complete the first 10 exercises on the 4Clojure website (<a href="http://www.4clojure.com" class="bare">http://www.4clojure.com</a>).</p>
</div>
</div>
<div class="sect2">
<h3 id="_optional_reading">Optional reading</h3>
<div class="paragraph">
<p>If you would like to get a head-start, please read the official Clojure introduction tutorial (<a href="http://clojure-doc.org/articles/tutorials/introduction.html" class="bare">http://clojure-doc.org/articles/tutorials/introduction.html</a>).
This material will be covered as part of the course.
Having read it before hand will allow you to focus on working through the exercises of the course.</p>
</div>
</div>
<div class="sect2">
<h3 id="_introductions">Introductions</h3>
<div class="quoteblock">
<blockquote>
Creativity is the ability to introduce order into the randomness of nature.
</blockquote>
<div class="attribution">
&#8212; Eric Hoffer
</div>
</div>
<div class="sect3">
<h4 id="_the_instructor">The instructor</h4>
<div class="paragraph">
<p>Timothy Pratley is the author of the book “Professional Clojure”, and a contributor to the Clojure core language.
He has 18 years of professional software development experience in banking, robotics, logistics, and advertising.
He spent the last 4 years exclusively using Clojure and ClojureScript developing enterprise systems for Fortune 500 companies.
He enjoys making YouTube videos about Clojure, running, and reading books.</p>
</div>
</div>
<div class="sect3">
<h4 id="_clojure">Clojure</h4>
<div class="paragraph">
<p>During this course we will be examining the Clojure language up close.
Sometimes a new language can feel different just for difference sake.
So why is it worth learning Clojure?</p>
</div>
<div class="paragraph">
<p>Clojure is simple and data-oriented.
Smart people want to use it.
Clojure enables teams to build things fast.
This makes it excellent for delivering value in enterprise development projects.</p>
</div>
<div class="paragraph">
<p>Throughout the course there will be time to reflect on what purpose the differences serve and what trade offs are being made.
These are the Clojure language themes to watch out for as we move through the course:</p>
</div>
<div class="sect4">
<h5 id="_data">Data</h5>
<div class="ulist">
<ul>
<li>
<p>Literals</p>
</li>
<li>
<p>Sequences</p>
</li>
<li>
<p>Transformations</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_functions">Functions</h5>
<div class="ulist">
<ul>
<li>
<p>Act on general purpose data structures</p>
</li>
<li>
<p>Pure</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_a_tool_for_thought">A tool for thought</h5>
<div class="ulist">
<ul>
<li>
<p>Concise</p>
</li>
<li>
<p>Unadorned</p>
</li>
<li>
<p>Abstract</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_getting_stuff_done">Getting stuff done</h5>
<div class="ulist">
<ul>
<li>
<p>Access to libraries</p>
</li>
<li>
<p>Performance</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_syntax_summary">Syntax Summary</h4>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Everything is a list with the operation at the front.</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Java</th>
<th class="tableblock halign-left valign-top">Clojure</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="literal"><pre>int i = 5;</pre></div></td>
<td class="tableblock halign-left valign-top"><div class="literal"><pre>(def i 5)</pre></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="literal"><pre>if (x == 0)
  return y;
else
  return z;</pre></div></td>
<td class="tableblock halign-left valign-top"><div class="literal"><pre>(if (zero? x)
  y
  z)</pre></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="literal"><pre>x * y * z;</pre></div></td>
<td class="tableblock halign-left valign-top"><div class="literal"><pre>(* x y z)</pre></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="literal"><pre>foo(x, y, z);</pre></div></td>
<td class="tableblock halign-left valign-top"><div class="literal"><pre>(foo x y z)</pre></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="literal"><pre>foo.bar(x);</pre></div></td>
<td class="tableblock halign-left valign-top"><div class="literal"><pre>(.bar foo x)</pre></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Things that would be declarations, control structures, function calls, operators, are all just lists with an op at front.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_clojure_ecosystem">1. The Clojure Ecosystem</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are many Clojure libraries. Hosted on Maven and Clojars. Just jars, like any other Java artifact.</p>
</div>
<div class="paragraph">
<p>Clojure is itself a Java library.
Clojure can make direct use of Java libraries.
ClojureScript can make direct use of JavaScript libraries.</p>
</div>
<div class="paragraph">
<p>The Clojure compiler is a Java library, a clojure.jar file. The only required installation is that Java must be installed. Clojure is very simple to deploy due to the lack of dependencies.</p>
</div>
<div class="paragraph">
<p>You can use Java tooling to manage your project, but Clojure has some tools to make the process easier.</p>
</div>
<div class="paragraph">
<p>Please follow along on your laptop and ask questions at any time.</p>
</div>
<div class="sect2">
<h3 id="_leiningen">1.1. Leiningen</h3>
<div class="paragraph">
<p>A popular project built tool that provides a convenient way to pull libraries for your project. Follow the installation instructions at (<a href="https://leiningen.org" class="bare">https://leiningen.org</a>).</p>
</div>
<div class="literalblock">
<div class="content">
<pre>lein new training
cd training
tree
cat project.clj
cat src/training/core.clj</pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, Leiningen created a project with one dependency; Clojure itself.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>lein repl</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_read_eval_print_loop_repl">1.2. The Read Eval Print Loop (REPL)</h3>
<div class="paragraph">
<p>When you type in this code:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(+ 1 2)</pre>
</div>
</div>
<div class="paragraph">
<p>Clojure evaluates it immediately and returns a result:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>=&gt; 3</pre>
</div>
</div>
<div class="paragraph">
<p>Pressing the up arrow moves through your history.</p>
</div>
<div class="paragraph">
<p>The REPL is convenient for experimenting and doing informal tests. But the default REPL is not ideal for editing code.</p>
</div>
</div>
<div class="sect2">
<h3 id="_editor_setup">1.3. Editor setup</h3>
<div class="paragraph">
<p>Most popular editors have plugins to send commands from the editor to a REPL, do syntax highlighting and manage parenthesis.
These are useful features, but I encourage you to prioritize learning Clojure ahead of configuring and learning new editor key combinations.
It is difficult to do both at once!</p>
</div>
<div class="paragraph">
<p>For this course I recommend using IntelliJ (<a href="https://www.jetbrains.com/idea" class="bare">https://www.jetbrains.com/idea</a>) with the Cursive Clojure plugin (<a href="https://cursive-ide.com" class="bare">https://cursive-ide.com</a>).
The main feature that sets Cursive apart is that it does error highlighting in the editor itself (<a href="https://cursive-ide.com/userguide" class="bare">https://cursive-ide.com/userguide</a>).</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Open the project we just created and launch a REPL.</p>
</li>
<li>
<p>Click file &#8594; open and browse to the project.clj file in the directory.</p>
</li>
<li>
<p>In the file navigator, right click the project.clj file and select launch REPL.</p>
</li>
<li>
<p>Press control+shift+T to send a form to the REPL.</p>
</li>
<li>
<p>Press control+shift+A to see all actions available.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Alternative: Lighttable (<a href="http://lighttable.com" class="bare">http://lighttable.com</a>)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Click File&#8594;open folder.</p>
</li>
<li>
<p>Browse to the “training” project directory that we created with lein.</p>
</li>
<li>
<p>Navigate to training/src/core.clj in the left hand tree view.</p>
</li>
<li>
<p>Press control+enter to send a form to the REPL.</p>
</li>
<li>
<p>Press control+space for a list of commands available.</p>
</li>
<li>
<p>Note that println will show up in the bottom console, which is hidden to begin.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can also open a REPL in your browser: (<a href="https://repl.it/languages/clojure" class="bare">https://repl.it/languages/clojure</a>).</p>
</div>
<div class="paragraph">
<p>For other editor options see (<a href="https://cb.codes/what-editor-ide-to-use-for-clojure" class="bare">https://cb.codes/what-editor-ide-to-use-for-clojure</a>).</p>
</div>
</div>
<div class="sect2">
<h3 id="_exercises">1.4. Exercises</h3>
<div class="paragraph">
<p>Evaluate some math expressions in the REPL:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Find the sum of 2 and 3</p>
</li>
<li>
<p>What is 31 times 79?</p>
</li>
<li>
<p>Divide 10 by 2</p>
</li>
<li>
<p>Divide 2 by 10</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Create a new project called <code>training</code>.
Open <code>src/training/core.clj</code> with your editor, write some expressions, and send them to the REPL:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Find the sum of 1, 2, and 3</p>
</li>
<li>
<p>Evaluate (println "hello world")</p>
</li>
<li>
<p>How many digits are in 5 factorial?</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_answers">1.5. Answers</h3>
<div class="literalblock">
<div class="content">
<pre>(+ 2 3)
=&gt; 5</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(* 31 79)
=&gt; 2449</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(/ 10 2)
=&gt; 5</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(/ 2 10)
=&gt; 1/5</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(+ 1 2 3)
=&gt; 6</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(println "hello world")
=&gt; "hello world"</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(* 5 4 3 2 1)
=&gt; 120</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_clojure_syntax">2. Clojure Syntax</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
The rhythmical unit of the syllable is at the back of all of it - the word, the phrase, the sentence, the syntax, the paragraph, and the way the heart moves when you read it.
</blockquote>
<div class="attribution">
&#8212; Ali Smith
</div>
</div>
<div class="sect2">
<h3 id="_primitive_data_types">2.1. Primitive data types</h3>
<div class="paragraph">
<p>Strings are enclosed in double quotes</p>
</div>
<div class="literalblock">
<div class="content">
<pre>"This is a string."</pre>
</div>
</div>
<div class="paragraph">
<p>Character literals are preceded by a backslash</p>
</div>
<div class="literalblock">
<div class="content">
<pre>\a \b \c \newline \tab</pre>
</div>
</div>
<div class="paragraph">
<p>Numbers can be Long</p>
</div>
<div class="literalblock">
<div class="content">
<pre>1</pre>
</div>
</div>
<div class="paragraph">
<p>Double</p>
</div>
<div class="literalblock">
<div class="content">
<pre>3.14</pre>
</div>
</div>
<div class="paragraph">
<p>BigInteger, suffixed with N</p>
</div>
<div class="literalblock">
<div class="content">
<pre>1000000000000N</pre>
</div>
</div>
<div class="paragraph">
<p>BigDecimal, suffixed with M</p>
</div>
<div class="literalblock">
<div class="content">
<pre>1000000000000.1M</pre>
</div>
</div>
<div class="paragraph">
<p>Expressed as exponents</p>
</div>
<div class="literalblock">
<div class="content">
<pre>1e3</pre>
</div>
</div>
<div class="paragraph">
<p>Or ratio</p>
</div>
<div class="literalblock">
<div class="content">
<pre>2/5</pre>
</div>
</div>
<div class="paragraph">
<p>Numbers are automatically promoted if they overflow during arithmetic.</p>
</div>
<div class="paragraph">
<p>Booleans are represented as <code>true</code> and <code>false</code>.</p>
</div>
<div class="paragraph">
<p><code>nil</code> means nothing and is considered false in logical tests.</p>
</div>
</div>
<div class="sect2">
<h3 id="_collections_lists_vectors_maps_and_sets">2.2. Collections: lists, vectors, maps, and sets</h3>
<div class="paragraph">
<p>Lists are forms enclosed in parentheses.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>()</pre>
</div>
</div>
<div class="paragraph">
<p>Lists are evaluated as function calls.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(inc 1)
=&gt; 2</pre>
</div>
</div>
<div class="paragraph">
<p>The first element in the list is the function, and any following elements are arguments.
Here we are calling the inc function on 1, which will return 2.</p>
</div>
<div class="paragraph">
<p>Quote yields the unevaluated form.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(quote (1 2))
=&gt; (1 2)</pre>
</div>
</div>
<div class="paragraph">
<p>Apostrophe is a syntactic shortcut for quote.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>'(1 2)
=&gt; (quote (1 2))
=&gt; (1 2)</pre>
</div>
</div>
<div class="paragraph">
<p>Clojure has a sequence abstraction.
Sequences can be lazy.
Their values are only created as they are consumed.</p>
</div>
<div class="paragraph">
<p>Lists and sequences are printed the same way.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(seq '(1 2 3))
=&gt; (1 2 3)</pre>
</div>
</div>
<div class="paragraph">
<p>Symbols are resolved.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>inc
=&gt; #object[clojure.core$inc]</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>foo
=&gt; Exception: Unable to resolve symbol foo</pre>
</div>
</div>
<div class="paragraph">
<p>To create an unresolved symbol, quote it</p>
</div>
<div class="literalblock">
<div class="content">
<pre>'foo
=&gt; foo</pre>
</div>
</div>
<div class="paragraph">
<p>Vectors are enclosed in square braces</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[1 2 3 4]</pre>
</div>
</div>
<div class="paragraph">
<p>Vectors have order 1 lookup by index and count.
Vectors are used in preference to lists for cases where either could be used.
Vectors do not require quoting and are visually distinct.
You will rarely see or use lists.</p>
</div>
<div class="paragraph">
<p>Clojure compares by identity and by value.
A vector with elements matching a sequence is equal to it.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(= [1 2 3] '(1 2 3))
=&gt; true</pre>
</div>
</div>
<div class="paragraph">
<p>Maps are key/value pairs</p>
</div>
<div class="literalblock">
<div class="content">
<pre>{"Language" "Clojure"
 "Version" 1.5
 "Author" "Rich Hickey"}</pre>
</div>
</div>
<div class="paragraph">
<p>Maps have near constant time lookup by key.
Maps are tuned to be fast.
Maps are an excellent replacement for object fields.</p>
</div>
<div class="paragraph">
<p>Keywords are shorthand identifiers that do not need to be declared.
Keywords begin with a colon.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>:language</pre>
</div>
</div>
<div class="paragraph">
<p>Keywords are often used as keys in hashmaps; similar to fields in an object.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>{:language "Clojure"
 :version 1.5
 :author "Rich Hickey"}</pre>
</div>
</div>
<div class="paragraph">
<p>Keywords can be namespaced.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>:timothy.example/rect</pre>
</div>
</div>
<div class="paragraph">
<p>Double colon is shorthand for a fully qualified keyword in the current namespace.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>::rect
=&gt; :timothy.example/rect</pre>
</div>
</div>
<div class="paragraph">
<p>Sets are written as</p>
</div>
<div class="literalblock">
<div class="content">
<pre>#{1 2 3}</pre>
</div>
</div>
<div class="paragraph">
<p>Sets have near constant time membership lookup, with a high branching factor.</p>
</div>
<div class="paragraph">
<p>Collections can be combined and nested</p>
</div>
<div class="literalblock">
<div class="content">
<pre>{[1 2] {:name "diamond" :type :treasure}
 [3 4] {:name "dragon" :type :monster}}</pre>
</div>
</div>
<div class="paragraph">
<p>This is a map that has vector coordinates as keys and maps as values.</p>
</div>
</div>
<div class="sect2">
<h3 id="_invoking_functions">2.3. Invoking functions</h3>
<div class="paragraph">
<p>To call a function, wrap it in parenthesis:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(inc 1)
=&gt; 2</pre>
</div>
</div>
<div class="paragraph">
<p>The first element in a list is a function to be called. The remaining elements are the arguments to the function.</p>
</div>
</div>
<div class="sect2">
<h3 id="_defining_vars">2.4. Defining vars</h3>
<div class="paragraph">
<p>A var is used to store a mutable reference to a value. Vars are unbound if no value is supplied.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(def x)
x
=&gt; #object[clojure.lang.Var$Unbound "Unbound: #'user/x"]</pre>
</div>
</div>
<div class="paragraph">
<p>It is more common to supply an initial value.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(def x 1)
x
=&gt; 1</pre>
</div>
</div>
<div class="paragraph">
<p>Def created a var named <code>x</code> which is bound to the value <code>1</code>. Vars are automatically dereferenced when evaluated.</p>
</div>
<div class="paragraph">
<p>To represent values that changes over time, you can use an atom.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(def a (atom 1))
(swap! a inc)
@a
=&gt; 2</pre>
</div>
</div>
<div class="paragraph">
<p>We defined <code>a</code> to be an atom with initial value <code>1</code>, then swapped the atom&#8217;s value with the <code>inc</code> function. We retrieved the value of the atom by dereference it with <code>@</code>. The current value of <code>a</code> is now <code>2</code>, the increment of <code>1</code>. <code>@</code> is shorthand for <code>deref</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(deref a)
=&gt; 2</pre>
</div>
</div>
<div class="paragraph">
<p>Atoms provide compare and set, which is suitable for non-transactional changes. Refs provide transactional change, which is suitable for multi-threaded change management. Agents provide update serialization as an alternative strategy for multi-threaded change.</p>
</div>
<div class="paragraph">
<p>Deref also blocks and gets the result of futures, promises and delays, which are operations that do not block until dereferenced.</p>
</div>
</div>
<div class="sect2">
<h3 id="_binding_names_with_let">2.5. Binding names with let</h3>
<div class="paragraph">
<p>Symbols:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>begin with an alphabet character</p>
</li>
<li>
<p>can contain numbers and punctuation</p>
</li>
<li>
<p>are usually lowercase words separated with hyphens</p>
</li>
<li>
<p>must be bound to values before they can be evaluated</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Symbols can be bound to a value in a scope with let.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(let [x 1]
  (inc x))
=&gt; 2</pre>
</div>
</div>
<div class="paragraph">
<p>The symbol <code>x</code> is bound to the value <code>1</code>, and the function <code>inc</code> is called on <code>x</code>, resulting in <code>2</code>.</p>
</div>
<div class="paragraph">
<p>The binding scope is within the parentheses enclosing the let form, and will shadow any existing bindings. It is preferable to use let instead of def for values that can be contained in a scope. Vars can be changed, but you should almost never modify them directly. Instead Clojure provides local bindings, atoms, refs and agents for managing change.</p>
</div>
</div>
<div class="sect2">
<h3 id="_destructuring_also_known_as_binding_forms">2.6. Destructuring (also known as binding forms)</h3>
<div class="literalblock">
<div class="content">
<pre>(let [[x y] [1 2]]
  (+ x y))
=&gt; 3</pre>
</div>
</div>
<div class="paragraph">
<p>Destructing is providing a literal data structure containing symbols that get bound to the respective parts of a value with a matching structure. Where we might otherwise bind the vector <code>[1 2]</code> to a single symbol, here we destructure two symbols <code>x</code> and <code>y</code> by providing a pattern that matches the vector.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn normalize
  "Divide all dimensions by the sum of squares"
  [[x y]]
  (let [length (Math/sqrt (+ (* x x) (* y y)))]
    [(/ x length) (/ y length)]))</pre>
</div>
</div>
<div class="paragraph">
<p>Note that function arguments are already a destructured vector. The above case is an example of a vector of arguments which contains a vector of <code>x</code> and <code>y</code>.</p>
</div>
<div class="paragraph">
<p>Destructuring avoids us having to extract substructure manually:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn normalize1 [v]
  (let [x (first v)
        y (second v)
        length (Math/sqrt (+ (* x x) (* y y)))]
    [(/ x length) (/ y length)]))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn normalize2 [[x y]]
  (let [length (Math/sqrt (+ (* x x) (* y y)))]
    [(/ x length) (/ y length)]))</pre>
</div>
</div>
<div class="paragraph">
<p>Destructuring is also useful in for comprehensions and loops:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn invert [m]
  (into {} (for [[k v] m]
             [v k])))</pre>
</div>
</div>
<div class="paragraph">
<p>In Clojure, for expressions are a convenient syntax alternative to map which also allows additional constraints to be expressed.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(for [i (range 10)
      :when (odd? i)]
  (* i i))
=&gt; (1 9 25 49 81)</pre>
</div>
</div>
<div class="paragraph">
<p>There is no need to restrict normalize to use 2 dimensions, instead we can write a generic version:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn normalize
  "Divide all dimensions by the sum of squares"
  [dims]
  (let [squares (map * dims dims)
        length (Math/sqrt (reduce + squares))
        by-length #(/ % length)]
    (map by-length dims)))
(normalize [3 4]) -&gt; (0.6 0.8)
(normalize [3 4 5]) -&gt; (0.424 0.566 0.707)</pre>
</div>
</div>
<div class="paragraph">
<p>Variadic functions are destructured using <code>&amp;</code>. Variadic means variable number of arguments. Arity means number of arguments.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn sub [&amp; vs]
  vs)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(sub 1 2 3 4)
=&gt; (1 2 3 4)</pre>
</div>
</div>
<div class="paragraph">
<p>Which produces a vector.
Apply expands the vector arguments.
Most mathematical functions are variadic:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(+ 1 2 3)
=&gt; 6</pre>
</div>
</div>
<div class="paragraph">
<p>Destructuring is nested, so you can use it to pull out sub-values without resorting to getter functions.</p>
</div>
<div class="paragraph">
<p>Common opportunities for destructuring are:</p>
</div>
<div class="paragraph">
<p>Values in a map:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(:field1 x)
(:field2 x)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>{:keys [field1 field2]} x</pre>
</div>
</div>
<div class="paragraph">
<p>Values in a sequence:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(first x)
(rest x)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>[a &amp; more]</pre>
</div>
</div>
<div class="paragraph">
<p>Nested destructuring</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(get-in x [:a :b])</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>{{b :b} :a}</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_namespaces">2.7. Namespaces</h3>
<div class="paragraph">
<p>Namespace forms occur at the start of files.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(ns training.core
  (:require [clojure.string :as string])
  (:import [java.util Date]))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(string/upper-case "shout")</pre>
</div>
</div>
<div class="paragraph">
<p>The namespace must match the path and filename. The namespace training.core
Must be defined in the <code>src/training/core.clj</code> file. Filename hyphens are replaced with underscores, and dot separators indicate directories.</p>
</div>
<div class="paragraph">
<p>The <code>ns</code> form allows us to require other namespaces and import java Classes. There are other valid <code>ns</code> forms which are best to be avoided and so are not shown here. If you do see them in other code, just know that you can and should achieve the same thing with the regular ns form described previously.</p>
</div>
<div class="paragraph">
<p>Clojure programs are written in expressions which are evaluated to results.  If an expression needs to be compiled, it will be. Programs can be loaded from files or evaluated dynamically.</p>
</div>
</div>
<div class="sect2">
<h3 id="_regex">2.8. Regex</h3>
<div class="paragraph">
<p>Regular expressions are written as <code>#"pattern"</code></p>
</div>
<div class="literalblock">
<div class="content">
<pre>(re-seq #"\w+" "the quick brown fox")
=&gt; ("the" "quick" "brown" "fox")</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_exercises_2">2.9. Exercises</h3>
<div class="paragraph">
<p>Write code into a new file called <code>src/training/syntax.clj</code>, and send the lines to the REPL as you enter them.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Set up the new namespace called <code>training.syntax</code></p>
</li>
<li>
<p>Define a var called <code>message</code> bound to the string <code>"greetings"</code>.</p>
</li>
<li>
<p>Print out the value of the var <code>message</code>.</p>
</li>
<li>
<p>Create a <code>let</code> binding that binds the symbol <code>message</code> to <code>"well hello there"</code>, and prints out <code>message</code> inside the <code>let</code> block.</p>
</li>
<li>
<p>Print out message again, outside of the <code>let</code> block.</p>
</li>
<li>
<p>Create a let binding that destructures the map
<code>{:greeting "good morning", :tone "happy"}</code>
and prints the greeting and tone inside the let block.</p>
</li>
<li>
<p>Destructure a single map input containing
<code>{:greeting "good morning", :tone "happy"}</code>
and return a string combining greeting and tone.
Use the <code>str</code> function.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_answers_2">2.10. Answers</h3>
<div class="literalblock">
<div class="content">
<pre>(ns training.syntax)
=&gt; nil</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(def message "greetings")
=&gt; #'hello-clojure/message</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(prn message)
=&gt; "greetings"
   nil</pre>
</div>
</div>
<div class="paragraph">
<p>Note the prn and println behave slightly differently; prn keeps the quotes around strings. This is often useful when experimenting, because you can visually see the type of the values more clearly.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(let [message "well hello there"]
  (prn message))
=&gt; "well hello there"
   nil</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(prn message)
=&gt; "greetings"</pre>
</div>
</div>
<div class="paragraph">
<p>Note that the message global var is still the original value.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(def m {:greeting "good morning", :tone "happy"})</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(let [{:keys [greeting tone]} m]
  (prn greeting tone))
=&gt; "good morning" "happy"</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn hi [{:keys [greeting tone]}]
  (str greeting " - " tone))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(hi m)
=&gt; "good morning - happy"</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_functions_2">3. Functions</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
The chief function of the body is to carry the brain around.
</blockquote>
<div class="attribution">
&#8212; Thomas A. Edison
</div>
</div>
<div class="sect2">
<h3 id="_defining_functions">3.1. Defining functions</h3>
<div class="paragraph">
<p>Functions are defined like this:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn square [x]
  (* x x))</pre>
</div>
</div>
<div class="paragraph">
<p>All functions return a result, the result of the last expression in the form. Defn binds the symbol square to a var which refers to a function which returns the result of multiplying the input parameter x by itself.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(square 2)
=&gt; 4</pre>
</div>
</div>
<div class="paragraph">
<p>When evaluated, a list containing square in the first position causes the var bound to square to be automatically dereferenced to the function, which is called on the arguments.</p>
</div>
<div class="paragraph">
<p>Mathematical operators are regular functions which must be written in prefix notation.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(+ (square 2) (square 3))
=&gt; 13</pre>
</div>
</div>
<div class="paragraph">
<p>Function arguments are evaluated from left to right before the function is called.</p>
</div>
<div class="paragraph">
<p>Unnamed functions are written as</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(fn [a]
  (inc a))</pre>
</div>
</div>
<div class="paragraph">
<p>Unnamed functions are also called anonymous functions and Lambda expressions.
There is a special syntax for creating unnamed functions.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>#(inc %)</pre>
</div>
</div>
<div class="paragraph">
<p>Is a function which increments a single argument.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(#(inc %) 1)
=&gt; 2</pre>
</div>
</div>
<div class="paragraph">
<p>Closures are functions that capture values from the environment.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(let [who "world"]
  (defn greet []
    (str "Hello " who))
(greet)
=&gt; "Hello world"</pre>
</div>
</div>
<div class="paragraph">
<p>Functions are values and can be passed as arguments to other functions. Functions that take a function as an argument are called higher order functions.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn higher-order-function [f]
  (f))
(higher-order-function greet)
=&gt; "Hello world"</pre>
</div>
</div>
<div class="paragraph">
<p>Map is function that calls a function on every element in a sequence</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(map #(inc %) [1 2 3])
=&gt; (2 3 4)</pre>
</div>
</div>
<div class="paragraph">
<p>Map is a higher order function because the first argument is a function.
Unnamed closures are useful as arguments to higher order functions.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(let [x 5]
  (map #(+ x %) [1 2 3]))
=&gt; (6 7 8)</pre>
</div>
</div>
<div class="paragraph">
<p>Here we have the symbol x bound to 5. We call the map function. Our first argument is an unnamed function that captures x from the environment; a closure. The closure is called on every element of the vector 1 2 3, resulting in a sequence 6 7 8. Higher order functions, closures, and unnamed functions are terms that describe specific uses of functions that allow concise expressions.</p>
</div>
</div>
<div class="sect2">
<h3 id="_pre_and_post_conditions">3.2. Pre- and post-conditions</h3>
<div class="paragraph">
<p>You can make assertions about inputs and outputs of a function. Place a map after the arguments vector containing :pre and :post, which are a sequence of conditions which must hold true.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn f [x]
  {:pre [(pos? x)]
   :post [(neg? %) (int? %)]}
  (- x))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(f 1)
=&gt; -1</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(f -1)
=&gt; AssertionError Assert failed: (pos? x)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(f 1.5)
=&gt; AssertionError Assert failed: (int? %)</pre>
</div>
</div>
<div class="paragraph">
<p>In practise pre and post are rarely used. It is more common to check for a condition and throw an exception:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn f [x]
  (when-not (pos? x)
    (throw (ex-info "bad input" {:x x}))
  (let [result (- x)]
    (if (and (neg? result) (int? result))
      result
      (throw (ex-info "bad result" {:x x})))</pre>
</div>
</div>
<div class="paragraph">
<p>Or to use a schema or spec (which will be covered later in the course).</p>
</div>
<div class="paragraph">
<p>While pre and post are more concise, they suffer the following drawbacks:
Syntax is easy to get wrong, resulting in no assertion being made
Assertions can be disabled
Less control over error description and handling</p>
</div>
</div>
<div class="sect2">
<h3 id="_anonymous_functions">3.3. Anonymous functions</h3>
<div class="paragraph">
<p>We usually define functions with defn, which creates a global var to hold our function. But sometimes the function need not be globally available. We can specify functions without names like so:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(fn [x]
  (inc x))</pre>
</div>
</div>
<div class="paragraph">
<p>But we would only do this if we wanted to make use of them in some way. The simplest way to use a function is to call it immediately:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>((fn [x]
   (inc x)
 1)
=&gt; 2</pre>
</div>
</div>
<div class="paragraph">
<p>The function appears as the first thing in a list, so is called on the argument 1, and evaluates the body of the function to calculate 2.</p>
</div>
<div class="paragraph">
<p>Another way to make use of an anonymous function is to bind it in a let form:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(let [f (fn [x]
          (inc x))]
  (f 2))
=&gt; 3</pre>
</div>
</div>
<div class="paragraph">
<p>In Clojure it is very common to pass a function as the argument to another function:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(map inc [1 2 3])
=&gt; (2 3 4)</pre>
</div>
</div>
<div class="paragraph">
<p>So having a way to specify an anonymous functions is helpful:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(map (fn [x]
       (* x x))
     [1 2 3 4])
=&gt; (1 4 9 16)</pre>
</div>
</div>
<div class="paragraph">
<p>You can name a function without creating a global var:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(fn add-one [x]
  (inc x))</pre>
</div>
</div>
<div class="paragraph">
<p>Naming a function has several benefits:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The name serves as a summary of the purpose of the function</p>
</li>
<li>
<p>The name will appear in stacktraces, giving a searchable clue in your code</p>
</li>
<li>
<p>The function can call itself</p>
</li>
<li>
<p>The name will not be available outside the function</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn f [x]
  (inc x))</pre>
</div>
</div>
<div class="paragraph">
<p>is shorthand for</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(def f
  (fn [x]
    (inc x)))</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_function_literals">3.4. Function literals</h3>
<div class="paragraph">
<p>There is a special syntax for creating anonymous functions concisely:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>#(inc %)
#(+ %1 %2)</pre>
</div>
</div>
<div class="paragraph">
<p>This allows the construction of very terse but powerful expressions:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(map #(* % %) [1 2 3 4])
=&gt; (1 4 9 16)</pre>
</div>
</div>
<div class="paragraph">
<p>I encourage you to use the (fn) form as much as possible instead of the #() form, it is not much more typing and affords more opportunity to name parameters and functions in meaningful ways which will describe your program better. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(map (fn square [x]
       (* x x))
     [1 2 3 4])
=&gt; (1 4 9 16)</pre>
</div>
</div>
<div class="paragraph">
<p>Is longer, but provides a semantic summary of the operation and a hint at the expected input values.</p>
</div>
</div>
<div class="sect2">
<h3 id="_keyword_and_variadic_arguments">3.5. Keyword and variadic arguments</h3>
<div class="literalblock">
<div class="content">
<pre>(defn f [&amp; args]
  args)
(f 1 2 3)
=&gt; (1 2 3)</pre>
</div>
</div>
<div class="paragraph">
<p>Variadic arguments sometimes introduce two disadvantages:
Causing callers to have to use apply
Bypasses arity checking</p>
</div>
<div class="paragraph">
<p>An antipattern is</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn f [x &amp; [y]]
  (if y
    (+ x y)
    (inc x)))</pre>
</div>
</div>
<div class="paragraph">
<p>Prefer instead</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn f
  ([x] (inc x))
  ([x y] (+ x y)))</pre>
</div>
</div>
<div class="paragraph">
<p>Clojure supports keyword arguments, but this style is discouraged because it prevents users from passing a map of options. We cannot apply a map to a keyword argument function, so use a map argument instead of keyword arguments.</p>
</div>
</div>
<div class="sect2">
<h3 id="_exercises_3">3.6. Exercises</h3>
<div class="paragraph">
<p>Create a new namespace called <code>fun-functions</code>. Define the following functions and call them with some test input:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A function that computes the square of an input number. What is the square of 55?</p>
</li>
<li>
<p>A function that takes a number as input, ensures that the number is less than 100, and returns the square of the square of the input.</p>
</li>
<li>
<p>A function that takes two numbers as input, and returns a vector where the first element is the second input, and the second element is the sum of the first and second input.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_answers_3">3.7. Answers</h3>
<div class="literalblock">
<div class="content">
<pre>(defn square [x]
  (* x x))
(square 55)
=&gt; 3025</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn square-of-square [x]
  (if (&lt; x 100)
    (square (square x))
    (throw (ex-info "Input too large" {:x x}))))
(square-of-square 2)
=&gt; 16
(square-of-square 123)
=&gt; ExceptionInfo Input too large</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn fib-step [a b]
  [b (+ a b)]))
(fib-step 1 1)
=&gt; [1 2]
(fib-step 1 2)
=&gt; [2 3]
(fib-step 2 3)
=&gt; [3 5]</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_challenge_1_corgi_cover_eligibility">Challenge 1: Corgi Cover eligibility</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Insuricorp is about to launch a marketing campaign for a new “corgi cover” policy.
Only certain people are eligible to register for “corgi cover”.
To be eligible they must own a corgi, live in either Illinois (IL), Washington (WA), New York (NY), or Colorado (CO).
You are tasked with building a system to validate applications for the policy.</p>
</div>
<div class="sect2">
<h3 id="_part_1">Part 1:</h3>
<div class="paragraph">
<p>Write a function that takes as input a state and corgi-count, and returns a boolean indicating the person&#8217;s eligibility for the “corgi cover” policy.</p>
</div>
<div class="sect3">
<h4 id="_test_data">Test data:</h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">State</th>
<th class="tableblock halign-left valign-top">Corgi count</th>
<th class="tableblock halign-left valign-top">Existing policy count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Chloe</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ethan</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Annabelle</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">WY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">19</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Logan</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">WA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>See <code>if</code> <code>=</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_part_2">Part 2:</h3>
<div class="paragraph">
<p>A focus group of corgi owners has revealed that “corgi cover” needs to be offered at 3 different tiers: “corgi cover silver”, “corgi cover gold”, and “corgi cover platinum”.
Platinum is available when covering 7 or more corgis OR covering at least 3 corgis and also having one other policy with Insuricorp.
Gold is available when covering at least 3 corgis. Silver is the original “corgi cover” policy.
Create a new function that takes an additional argument policy-count and returns a keyword indicating their eligibility.</p>
</div>
<div class="paragraph">
<p>See <code>cond</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_part_3">Part 3:</h3>
<div class="paragraph">
<p>The “corgi cover” applications Insuricorp collect contain more information than necessary to determine eligibility.
Create a new function that takes as input a single map data structure as input instead of multiple inputs.
It should pick out the values that it needs from the input map.
Create some test data and feed it to your function.
The data should look something like:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>{:name "Chloe", :state "IL", :corgi-count 1, :policy-count 0}</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_part_4">Part 4:</h3>
<div class="paragraph">
<p>Insuricorp just merged with Megacorp.
Platinum level corgi cover is now offered to people with an existing Megacorp policy as well.
Because the company is still restructuring, the policy-count input still only contains Insuricorp data.
But a new input has been made available to you which is a map of people to policies.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>{"Chloe" ["secure goldfish"]
 "Ethan" ["cool cats cover" "megasafe"]}</pre>
</div>
</div>
<div class="paragraph">
<p>Create a new function that takes as inputs two maps: the application, and the existing policies.
It should apply the same logic, but make use of the Megacorp data.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_testing_with_clojure_test">4. Testing with clojure.test</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
The greatest test of courage on earth is to bear defeat without losing heart.
</blockquote>
<div class="attribution">
&#8212; Robert Green Ingersoll
</div>
</div>
<div class="sect2">
<h3 id="_defining_tests_with_deftest">4.1. Defining tests with deftest</h3>
<div class="paragraph">
<p>You can define a test in any file, but it is common to put all test code in a separate “test” directory, and to create namespaces that mirror the “src” directory but have -test appended.
So if we have a source file <code>src/my_namespace.clj</code> then we create a test file as <code>test/my_namespace_test.clj</code>.</p>
</div>
<div class="paragraph">
<p>Test namespaces are normal Clojure namespaces.
Test related functions come from the <code>clojure.test</code> namespace, so it is common to refer all symbols from <code>clojure.test</code> for convenience:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(ns my-namespace-test
  (:require [clojure.test :refer :all]))</pre>
</div>
</div>
<div class="paragraph">
<p>A test is just a function that takes no arguments and will be called by the Clojure test runner.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(deftest my-test
  (prn "My test ran"))</pre>
</div>
</div>
<div class="paragraph">
<p>You can run the tests manually from the REPL:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(run-tests)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>=&gt; "My test ran"
Ran 0 tests containing 0 assertions.
0 failures, 0 errors.
{:test 0, :pass 0, :fail 0, :error 0, :type :summary}</pre>
</div>
</div>
<div class="paragraph">
<p>To run all tests in a project from the command line:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ lein test</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>=&gt; "My test ran"
Ran 0 tests containing 0 assertions.
0 failures, 0 errors.
{:test 0, :pass 0, :fail 0, :error 0, :type :summary}</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_lein_test_refresh">4.2. lein-test-refresh</h3>
<div class="paragraph">
<p>Lein-test-refresh is a Leiningen plugin that reloads code and re-runs tests when you save a file.
<a href="https://github.com/jakemcc/lein-test-refresh" class="bare">https://github.com/jakemcc/lein-test-refresh</a>.</p>
</div>
<div class="paragraph">
<p>Add lein-test-refresh to your <code>~/.lein/profiles.clj</code>. It should look similar to below.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>{:user {:plugins [[com.jakemccrary/lein-test-refresh "0.22.0"]]}}</pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively you may add it to your <code>project.clj</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defproject sample
  :dependencies [[org.clojure/clojure "1.8.0"]]
  :profiles
  {:dev
   {:plugins [[com.jakemccrary/lein-test-refresh "0.22.0"]]}})</pre>
</div>
</div>
<div class="paragraph">
<p>Now you can watch for changes from the command line:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ lein test-refresh</pre>
</div>
</div>
<div class="paragraph">
<p>If you change <code>my-test</code> now to print a new message, the tests are re-run as soon as you save the file&#8230;&#8203; giving immediate feedback on your change.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(deftest my-test
  (prn "My test ran immediately"))</pre>
</div>
</div>
<div class="paragraph">
<p>Seeing as saving the file executes code, you can use lein-test-refresh like a REPL.</p>
</div>
</div>
<div class="sect2">
<h3 id="_assertions_with_is_and_are">4.3. Assertions with is and are</h3>
<div class="paragraph">
<p>Let&#8217;s begin with a false assertion:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(deftest my-test
  (is (= 1 (inc 1))))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>=&gt; FAIL in (my-test)
   expected: (= 1 (inc 1))
     actual: (not (= 1 2))</pre>
</div>
</div>
<div class="paragraph">
<p>And then convert it to a true assertion:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(deftest my-test
  (is (= 2 (inc 1))))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>=&gt; Ran 1 tests containing 1 assertions.
   0 failures, 0 errors.</pre>
</div>
</div>
<div class="paragraph">
<p>We have written a test that makes an assertion about the function <code>inc</code>.
Most tests check for equality with the expected value first, and the actual value second.
The expected value is a literal expression and the actual is a call to the function under test.
However you are not limited to following this for every test case.
You can use any truthy assertion.
Here is an example that does not do equality checking:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(deftest my-test
  (is (odd? 1)))</pre>
</div>
</div>
<div class="paragraph">
<p>If your assertion expression is not self explanatory, supply an optional string argument which describes the assertion:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(deftest my-test
  (is (= (* 5 5) (+ (* 3 3) (* 4 4)))
    "The square of the hypotenuse is equal to the sum of the squares of the other two sides"))</pre>
</div>
</div>
<div class="paragraph">
<p>And to group assertions into logical blocks, use the testing form:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(deftest math-test
  (testing "basic math"
    (is (odd? 1))
    (is (= 2 (inc 1))))
  (testing "pythagoras"
    (is (= (* 5 5) (+ (* 3 3) (* 4 4)))
    "The square of the hypotenuse is equal to the sum of the squares of the other two sides"))</pre>
</div>
</div>
<div class="paragraph">
<p>It is also possible to more concisely express multiple assertions using the are form:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(are [x y] (= x y)
     2 (+ 1 1)
     4 (* 2 2))</pre>
</div>
</div>
<div class="paragraph">
<p>However I recommend you avoid this form.
It is easy to make an error in the syntax, and can be confusing.
Furthermore line numbers are not preserved, so a failing test case is harder to identify.</p>
</div>
<div class="paragraph">
<p>Occasionally we need to assert that an exception is thrown:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn bad [x]
  (throw (ex-info "oh no" {})))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(deftest test-exception
  (is (thrown-with-msg? Exception #"oh no"
        (bad 42))))</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_test_fixtures">4.4. Test fixtures</h3>
<div class="paragraph">
<p>Test fixtures are for setting up and tearing down resources required by your tests.
We can specify <code>:once</code> fixtures that execute one time for all tests in the namespace, or <code>:each</code> fixtures that run around each test in the namespace.</p>
</div>
<div class="paragraph">
<p>A fixture is simply a function that takes a test and executes it.
Recall that tests are functions.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(use-fixtures :once
  (fn print-enter-exit [tests]
    (println "before")
    (tests)
    (println "after")))</pre>
</div>
</div>
<div class="paragraph">
<p>Now the test runner will print out “before”, execute the tests in the namespace, and then print out “after”.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(use-fixtures :every
  (fn capture-prints [f]
    (with-out-str (f))))</pre>
</div>
</div>
<div class="paragraph">
<p>Here we prevent printing within our function from appearing in the console.
Usually we want our tests to make assertions, but not produce output.
Otherwise the test report can be cluttered.</p>
</div>
<div class="paragraph">
<p>Another common use case is when doing database tests, we can wrap the test execution inside a transaction and rollback after the test completes.
This avoids cleaning up data after the tests run, as no data was created.</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_with_redefs_for_mocking_behavior">4.5. Using with-redefs for mocking behavior</h3>
<div class="paragraph">
<p>Often when we are writing tests we want to isolate particular behaviors.
Some parts of a function might not be appropriate to occur during the test.
We can conveniently replace the definition of any var during a test using with-redefs:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn post [url]
  {:body (str "Hello world")})</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(deftest test-post
  (with-redefs [str (fn [&amp; args]
                       "Goodbye world")]
    (is (= {:body "Goodbye world"}
           (post "http://service.com/greet")))))</pre>
</div>
</div>
<div class="paragraph">
<p>At first glance this is very similar to let, but notice that a let would not work in this example.
We changed the behavior of the str function whose definition is outside the scope of the test.
We replaced it with an anonymous function that always returns “Goodbye world” regardless of its inputs.
Note that we could have used (constantly "Goodbye world") instead, which produces an anonymous function just like the one we defined.</p>
</div>
</div>
<div class="sect2">
<h3 id="_debugging">4.6. Debugging</h3>
<div class="paragraph">
<p>While working on a function, sometimes it is useful to print out an intermediary value.
One way to accomplish this is using doto.
Say that we were working on a complicated nested function:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn shazam [a b]
  (/ 1 (+ a b) (+ a (* a b))))</pre>
</div>
</div>
<div class="paragraph">
<p>And we wanted to see what <code>(+ a (* a b))</code> was evaluating to in the context of the function call.
We can temporarily wrap the expression in <code>(doto &#8230;&#8203; (prn))</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn shazam [a b]
  (/ 1 (+ a b) (doto (+ a (* a b)) (prn "***"))))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(shazam 1 2)
=&gt; 3 "***"
   1/9</pre>
</div>
</div>
<div class="paragraph">
<p>The difference from wrapping with just <code>prn</code> is that <code>prn</code> always returns <code>nil</code>, while <code>doto</code> will cause the <code>prn</code> side-effect to occur, but will return the original argument.
This is also very useful when interacting with Java, because you can construct an object, call various methods on it, and return the object constructed.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(doto (new java.util.HashMap)
  (.put "a" 1)
  (.put "b" 2))
=&gt; {"a" 1, "b" 2}</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_exercises_4">4.7. Exercises</h3>
<div class="ulist">
<ul>
<li>
<p>Start lein-test-refresh running in your existing project directory.</p>
</li>
<li>
<p>Create a new namespace in the “test” directory called <code>training.core-test</code></p>
</li>
<li>
<p>Write a function called <code>pythag</code> that returns the square root of the sum of squares for two inputs.</p>
</li>
<li>
<p>Write a test containing an assertion that exercises your function. Expect <code>5</code> when passing <code>4</code> and <code>3</code> as arguments.</p>
</li>
<li>
<p>Write another test case with different inputs.</p>
</li>
<li>
<p>Introduce a bug into pythag to make sure your tests discover the problem.</p>
</li>
<li>
<p>Fix <code>pythag</code> so that all tests pass.</p>
</li>
<li>
<p>Copy the test <code>test-post</code> from the "with-redefs" section and modify it so that it counts how many times <code>str</code> gets called. Call <code>post</code> several times and make an assertion about how many times <code>str</code> should get called.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_answers_4">4.8. Answers</h3>
<div class="literalblock">
<div class="content">
<pre>(defn pythag [a b]
  (Math/sqrt (+ (* a a) (* b b))))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(deftest test-pythag
  (is (= 5 (pythag 4 3)))
  (is (= 13 (pythag 12 5))))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn post [url]
  {:body (str "Hello world")})</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(deftest test-post
  (let [c (atom 0)]
    (with-redefs [str (fn [&amp; args]
                        (swap! c inc)
                        "Goodbye world")]
      (post "http://service.com/greet")
      (post "http://service.com/greet")
      (post "http://service.com/greet")
      (is (= 3 @c)))))</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_control_flow">5. Control Flow</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
Goals allow you to control the direction of change in your favor.
</blockquote>
<div class="attribution">
&#8212; Brian Tracy
</div>
</div>
<div class="paragraph">
<p>Clojure provides special forms for control flow.
Special forms are built in primitives that behave differently from functions.
We already saw several special forms in action: <code>def</code>, <code>let</code>, <code>quote</code> and <code>fn</code> are all special forms.
The main thing that is different about them is that they don&#8217;t evaluate all their arguments like a regular function call.</p>
</div>
<div class="sect2">
<h3 id="_conditionals_if_when_cond">5.1. Conditionals: if, when, cond</h3>
<div class="paragraph">
<p>Another special form is if which chooses between two options.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(if (pos? 1)
  (println "one is positive")
  (println "or is it?"))
=&gt; "one is positive"</pre>
</div>
</div>
<div class="paragraph">
<p>Only one branch is evaluated, whereas a function call evaluates all arguments.</p>
</div>
<div class="paragraph">
<p>Often we want to execute some code only when a condition is met:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(when (pos? 1)
  (println "one is positive")
  (println "multiple expressions allowed"))
=&gt; "one is positive"
   "multiple expressions allowed"</pre>
</div>
</div>
<div class="paragraph">
<p>When the test fails, nothing is evaluated, when it passes, everything in the body is evaluated.</p>
</div>
<div class="paragraph">
<p>Cond allows for multiple branches.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(def x {:cake 1})
(cond (= x 1) "one"
      (= x :cake) "the cake is a lie"
      (map? x) "it's a map!"
      :else "not sure what it is")
=&gt; "it's a map!"</pre>
</div>
</div>
<div class="paragraph">
<p>Note that <code>:else</code> is not a special keyword, it just happens to be a truthy value.</p>
</div>
</div>
<div class="sect2">
<h3 id="_recursion">5.2. Recursion</h3>
<div class="paragraph">
<p>Functions that call themselves are called recursive. Here is an example of recursion:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn sum-up [coll result]
  (if (empty? coll)
    result
    (sum-up (rest coll) (+ result (first coll)))))</pre>
</div>
</div>
<div class="paragraph">
<p>In Clojure there is a special way to do recursion which avoids consuming the stack:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn sum-up-with-recur [coll result]
  (if (empty? coll)
    result
    (recur (rest coll) (+ result (first coll)))))</pre>
</div>
</div>
<div class="paragraph">
<p>Recur can only occur at the last position of a function (where scope can be discarded).</p>
</div>
</div>
<div class="sect2">
<h3 id="_loops">5.3. Loops</h3>
<div class="paragraph">
<p>Loop establishes bindings, and allows you to recur back to the start of the loop with new values.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(loop [a 0
       b 1]
  (if (&lt; b 1000)
    (recur b (+ a b))
    a))
=&gt; fib number below 1000</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_exception_handling">5.4. Exception handling</h3>
<div class="paragraph">
<p>You can work with exceptions using try catch finally and throw.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(try
  (inc "cat")
  (catch Exception e
    (println "cat cannot be incremented")))</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_comments">5.5. Comments</h3>
<div class="paragraph">
<p>Anything following a semicolon is a comment</p>
</div>
<div class="literalblock">
<div class="content">
<pre>; this is an inline comment
;; this is a function level comment</pre>
</div>
</div>
<div class="paragraph">
<p>Less common is the comment form:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(comment anything)</pre>
</div>
</div>
<div class="paragraph">
<p>And a special form for complete removal of any form it is prefixed to</p>
</div>
<div class="literalblock">
<div class="content">
<pre>#_(this form is removed)</pre>
</div>
</div>
<div class="paragraph">
<p>Which is handy for temporarily removing a form when modifying code.
You can use hash-underscore multiple times to comment out multiple forms.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>#_#_ ignored-1 ignored-2</pre>
</div>
</div>
<div class="paragraph">
<p>I call this the bug eyes operator, because it looks like a bug emoji.</p>
</div>
<div class="paragraph">
<p>Commas are optional and treated as whitespace.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(= {:a 1, :b 2, :c 3} {:a 1 :b 2 :c 3})</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_exercises_5">5.6. Exercises</h3>
<div class="ulist">
<ul>
<li>
<p>Create a function that given a test score between 0 and 100 returns a grade A B C D or F for fail.</p>
</li>
<li>
<p>Write a function that takes a number and uses a loop to calculate the factorial of that number. Factorial 5 is 1*2*3*4*5.</p>
</li>
<li>
<p>Write a new version of factorial that does not use a loop but recursively calls itself.</p>
</li>
<li>
<p>Write a loop for the Fibonacci sequence (1 1 2 3 5 8 13) that finds the maximum Fibonacci number less than 100. The sequence is defined by n2 = n1 + n0.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_answers_5">5.7. Answers</h3>
<div class="literalblock">
<div class="content">
<pre>(def grade [score]
  (cond (&gt;= score 90) "A"
        (&gt;= score 80) "B"
        (&gt;= score 70) "C"
        (&gt;= score 60) "D"
        :else "F"))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn factorial [n]
  (loop [acc 1
         x n]
    (if (&lt;= x 1)
      acc
      (recur (* acc x) (dec x)))))
(deftest factorial-test
  (is (= 120 (factorial 5))))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn factorial2
  ([n] (factorial 1 n))
  ([acc n]
   (if (&lt;= n 1)
     acc
     (recur (* acc n) (dec n)))))
(deftest factorial2-test
  (is (= 120 (factorial2 5))))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn fib [limit]
  (loop [a 1
         b 1]
    (if (&gt;= b limit)
      a
      (recur b (+ a b)))))
(deftest fib-test
  (is (= 89 (fib 100))))</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_functional_programming">6. Functional Programming</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
If you don&#8217;t love something, it&#8217;s not functional, in my opinion.
</blockquote>
<div class="attribution">
&#8212; Yves Behar
</div>
</div>
<div class="sect2">
<h3 id="_pure_functions_and_side_effects">6.1. Pure functions and side effects</h3>
<div class="paragraph">
<p>You have probably noticed that Clojure functions always return a value.
Moreover they usually return a useful result, not just a nil.
There is a distinction to be made between functions which produce useful result values from functions which cause side-effects.</p>
</div>
<div class="paragraph">
<p>Functions that produces side effects are often called in a way that discards their result.
For example calling <code>(println "hi")</code> is done not because we want a result.
<code>println</code> returns <code>nil</code>, which is useless.
What we want is to print to System out the string <code>"hi"</code>, which occurs as a side-effect of us calling the function.
Contrast that with calling <code>(str "hi" "there")</code>, which returns a new string <code>"hithere"</code>; no side-effects occur.</p>
</div>
<div class="paragraph">
<p>A function with no side-effects is a pure function.
Calling pure functions with a given input always results with the same corresponding output.
Note that <code>rand</code> is not a pure function even though it returns a useful result, because it produces a different output every time.</p>
</div>
<div class="paragraph">
<p>Pure functions are desirable because they are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>easier to reason about</p>
</li>
<li>
<p>easier to combine</p>
</li>
<li>
<p>easier to test</p>
</li>
<li>
<p>easier to debug</p>
</li>
<li>
<p>easier to parallelize</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Clojure api provides many pure functions.
For example <code>conj</code> does not add something to a vector, it returns a completely new vector!</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(def v [1 2])
(conj v 3)
=&gt; [1 2 3]</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>v
=&gt; [1 2]</pre>
</div>
</div>
<div class="paragraph">
<p>In this example we can see that v remained unchanged.
Clojure implements data structures that enable this to happen efficiently.
Using a regular Java vector would require duplicating the vector, but Clojure makes use of a technique called shared structure to provide immutable data structures that don&#8217;t require the entire object to be duplicated.</p>
</div>
<div class="paragraph">
<p>Clojure does allow side-effects, indeed they are very useful.
It is good style to keep side-effects co-located instead of having them occur throughout various parts of the code.
We will see some good examples of this philosophy in action later in the course when we get to atoms.
We can use pure function to calculate the next value to be assigned to an atom given the current value.
The logic is separate from the side effect.</p>
</div>
</div>
<div class="sect2">
<h3 id="_apply_partial_and_comp">6.2. Apply, partial, and comp</h3>
<div class="paragraph">
<p>If you have 4 numbers and want the max, you can call</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(max 1 2 5 3)
=&gt; 5</pre>
</div>
</div>
<div class="paragraph">
<p>But what if you have a sequence of many numbers?
What if you don&#8217;t know how many numbers there will be?
Fortunately there is a way to convert a sequence of arguments into a function call:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(apply max [1 2 5 3])
=&gt; 5</pre>
</div>
</div>
<div class="paragraph">
<p>This is especially useful when calling variadic functions like max.
Note that we could have alternatively reduced over the sequence, but apply is much more concise and clear about the intent.</p>
</div>
<div class="paragraph">
<p>In Clojure we often pass functions as values, so there is a convenient way to create a function that consumes some arguments that can be used with additional arguments later:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(partial + 1)</pre>
</div>
</div>
<div class="paragraph">
<p>Creates a function that adds 1 to any number of arguments supplied.
It returns a function that is equivalent to:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(fn [&amp; args]
  (apply + 1 args))</pre>
</div>
</div>
<div class="paragraph">
<p>So let&#8217;s see how we might make use of that:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>((partial + 1) 2 3)
=&gt; 6</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(map (partial / 1) (range 1 5))
=&gt; (1 1/2 1/3 1/4)</pre>
</div>
</div>
<div class="paragraph">
<p>In the previous example, we could have instead written:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(map #(/ 1 %) (range 1 5))
=&gt; (1 1/2 1/3 1/4)</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_functions_on_sequences_map_reduce_and_friends">6.3. Functions on sequences: map, reduce, and friends</h3>
<div class="paragraph">
<p>To really embrace Clojure is to think in terms of sequences and data structures.</p>
</div>
<div class="paragraph">
<p>The most basic way to construct a sequence is like so:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(cons 1 ())
=&gt; (1)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(cons 3 (cons 2 (cons 1 ())))
=&gt; (3 2 1)</pre>
</div>
</div>
<div class="paragraph">
<p>But Clojure provides several easier ways to create a sequence:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(range 10)
=&gt; (0 1 2 3 4 5 6 7 8 9)</pre>
</div>
</div>
<div class="paragraph">
<p>Be careful though, Clojure can produce infinite sequences (don&#8217;t do this in a REPL):</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(range)</pre>
</div>
</div>
<div class="paragraph">
<p>This would attempt to keep producing numbers forever.
(Press control-c to cancel the REPL if you did try this).
There is a way to limit the amount of values to take:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(take 5 (range))
=&gt; (0 1 2 3 4)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(drop 5 (take 5 (range)))
=&gt; (5 6 7 8 9)</pre>
</div>
</div>
<div class="paragraph">
<p>Clojure has an excellent sequence abstraction that fits naturally into the language.
From a vector <code>[1 2 3 4]</code> we can find the odd numbers by calling the filter function:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(filter odd? [1 2 3 4])
=&gt; (1 3)</pre>
</div>
</div>
<div class="paragraph">
<p>Here we called the <code>filter</code> function with two arguments: the <code>odd?</code> function and a vector of integers.
<code>filter</code> is a higher order function, since it takes an input function to use in its computation.
The result is a sequence of odd values.
Functions like filter that operate on sequences call seq on their arguments to convert collections to sequences.
The underlying mechanism is the <code>ISeq</code> interface, which allows many collection data structures to provide access to their elements.</p>
</div>
<div class="paragraph">
<p><code>map</code> is a function that calls another function for every element in a sequence:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(map inc [1 2 3 4])
=&gt; (2 3 4 5)</pre>
</div>
</div>
<div class="paragraph">
<p>The result is a sequence of the increment of each number in <code>[1 2 3 4]</code>.</p>
</div>
<div class="paragraph">
<p>Sequences can be used as input arguments to other functions as shown here:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(filter odd? (map inc [1 2 3 4]))
=&gt; (3 5)</pre>
</div>
</div>
<div class="paragraph">
<p>Here we filtered by <code>odd?</code> the values from <code>(2 3 4 5)</code>, which was the result of calling <code>map</code>.</p>
</div>
<div class="paragraph">
<p>To aggregate across a sequence, use <code>reduce</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(reduce * [1 2 3 4])
=&gt; 24</pre>
</div>
</div>
<div class="paragraph">
<p>For each element in the sequence, reduce computes <code>(* aggregate element)</code> and passes the result of that as the aggregate for the next calculation.
The first element <code>1</code> is used as the initial value of aggregate.
The final result is 1 * 2 * 3 * 4.</p>
</div>
<div class="paragraph">
<p>Clojure provides a built-in function for grouped aggregates:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(group-by count ["the" "quick" "brown" "fox"])
=&gt; {3 ["the" "fox"], 5 ["quick" "brown"]}</pre>
</div>
</div>
<div class="paragraph">
<p>3 letter words are "the" and "fox", whereas 5 letter words are "quick" and "brown".</p>
</div>
<div class="paragraph">
<p><code>filter</code> is like a Java loop:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>for (i=0; i &lt; vector.length; i++)
 if (condition)
     result.append(vector[i]);</pre>
</div>
</div>
<div class="paragraph">
<p><code>map</code> is like a Java loop:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>for (i=0; i &lt; vector.length; i++)
    result[i] = func(vector[i]);</pre>
</div>
</div>
<div class="paragraph">
<p><code>reduce</code> is like a Java loop:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>for (i=0; i &lt; vector.length; i++)
    result = func(result, vector[i]);</pre>
</div>
</div>
<div class="paragraph">
<p>Sequence abstractions are like names for loops that you can add to your vocabulary to talk about and recognize different kinds of loops.
Learning the names of the abstractions and patterns that replace loops is an effort, but it adds powerful words to a programmer&#8217;s vocabulary.
A large vocabulary facilitates reasoning more succinctly, communicating more effectively, and writing less code that does more.</p>
</div>
<div class="paragraph">
<p>Clojure provides a special form <code>#()</code> to create an anonymous function:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>#(&lt; % 3)</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>%</code> symbol is an implied input argument.
This function takes one argument and returns <code>true</code> if the input argument is less than <code>3</code>, otherwise it is <code>false</code>.
Anonymous functions are handy for adding small snippets of logic:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(filter #(&lt; % 3) [1 2 3 4 5]))
=&gt; (0 1 2)</pre>
</div>
</div>
<div class="paragraph">
<p>This keeps only numbers less than <code>3</code>. Now let&#8217;s create a sequence of odd/even labels for each number in the vector:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(map #(if (odd? %) "odd" "even") [1 2 3 4 5])
=&gt; ("odd" "even" "odd" "even" "odd")</pre>
</div>
</div>
<div class="paragraph">
<p>Sequence abstractions are more concise and descriptive than loops, especially when filtering multiple conditions, or performing multiple operations.</p>
</div>
<div class="paragraph">
<p>Clojure also has useful functions for constructing sequences:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(range 5)
=&gt; (0 1 2 3 4)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(repeat 3 1)
=&gt; (1 1 1)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(partition 3 (range 9))
=&gt; ((0 1 2) (3 4 5) (6 7 8))</pre>
</div>
</div>
<div class="paragraph">
<p>One situation that appears difficult to use a sequence abstraction in is when we have a vector of numbers and wish to perform a sequence operation that relies upon the previous value visited.
For example, think about finding the sum of each pair in <code>[1 2 3 4 5]</code>.
Using an imperative style loop we can peek into the vector at the previous value:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>for (i=1; i &lt; v.length; i++)
    print v[i] + v[i-1];
=&gt; 3 5 7 9</pre>
</div>
</div>
<div class="paragraph">
<p>Can we represent this as a sequence? Yes! Imagine two identical sequences offset slightly:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>  [1 2 3 4 5]
[1 2 3 4 5]</pre>
</div>
</div>
<div class="paragraph">
<p>The overlapping values are the pairs we want.</p>
</div>
<div class="paragraph">
<p><code>map</code> can take multiple sequences from which to pull arguments for the input function:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(map + [1 3]
       [2 4])
=&gt; (3 7)</pre>
</div>
</div>
<div class="paragraph">
<p>Here <code>1</code> adds to <code>2</code> to make <code>3</code>, and <code>3</code> adds to <code>4</code> to make <code>7</code>.</p>
</div>
<div class="paragraph">
<p><code>rest</code> is a function which returns the input sequence without its first element:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(def v [1 2 3 4 5])
(rest v)
=&gt; (2 3 4 5)</pre>
</div>
</div>
<div class="paragraph">
<p>Putting them together:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(map + v (rest v))
=&gt; (3 5 7 9)</pre>
</div>
</div>
<div class="paragraph">
<p>We called map on the addition function over both input sequences:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>v        =&gt; (1 2 3 4 5)
(rest v) =&gt; (2 3 4 5)</pre>
</div>
</div>
<div class="paragraph">
<p>The input sequences were of different lengths, so map stopped when the smallest sequence was exhausted. The result was a new sequence of the pairwise sums:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(3 5 7 9)</pre>
</div>
</div>
<div class="paragraph">
<p>Why are sequence abstractions better than loops?
When reading a loop you must comprehend the entire block of code to know what it does.
As the loop body grows and changes you must mentally keep track of more complexity.
Mistakes like “off by one” are hard to spot, and can creep in as the code changes.
Testing requires the invasion of the loop with breakpoints.
You may find yourself duplicating a loop to customize some similar operation.
The loop abstraction is very easy to understand and use, but it does not provide leverage.</p>
</div>
<div class="paragraph">
<p>Imagine discovering a new requirement where you need to multiply all of those numbers together.
The change is invasive to the imperative loop:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>result = 1;
for (i=1; i &lt; v.length; i++)
    result *= (v[i] + v[i-1]);
=&gt; 945</pre>
</div>
</div>
<div class="paragraph">
<p>The change occurs inside the loop with the addition and multiplication intertwined.</p>
</div>
<div class="paragraph">
<p>Contrast this with modifying the Clojure sequence. We compose a reduce with the original map expression:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(reduce * (map + v (rest v)))
=&gt; 945</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>reduce</code>: Aggregate by multiplication the sequence</p>
</li>
<li>
<p><code>map</code>: adding items together from two sequences</p>
</li>
<li>
<p><code>pairing</code>: the sequence of elements in v, adjacent to the rest of v</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is dense, but descriptive code&#8230;&#8203; if you know the vocabulary.</p>
</div>
<div class="paragraph">
<p>With a sequence you can write unit tests for the component sequences and operations, reuse the same sequence without writing new code, and reason about the transformations as composable parts.</p>
</div>
<div class="paragraph">
<p>Look out for opportunities to name your steps by identifying long expressions and creating a named function out of them.</p>
</div>
<div class="paragraph">
<p>Clojure exposes a sequence interface over data collections to a rich set of functions that compose well.
Three important functional sequence concepts are:
 <code>filter</code>, which retains each item in a sequence where some function evaluates to be truthy;
 <code>map</code>, which selects new values by calling a function over input sequence(s) to create a new sequence;
 and <code>reduce</code>, which aggregates a sequence and returns a single value.</p>
</div>
<div class="paragraph">
<p>I invite you to take the “no loops” challenge.
The next time you spot a loop stop and think about what sequence operation the loop represents.
Think about how to rewrite the loop as sequence operations instead.
It will take time and mental effort, but you will be rewarded with a deeper understanding of the problem being solved.
Whenever you see a loop, think about how it could be expressed as a sequence.
Sequences are loop abstractions that allow you to ignore the implementation details.</p>
</div>
</div>
<div class="sect2">
<h3 id="_threading_operators">6.4. Threading operators</h3>
<div class="paragraph">
<p>By now, you should be feeling the combinatorial power functions offer.
Simple functions compose sequence operations together to build transforms.
Clojure has almost one hundred functions related to sequences, so you should also be feeling wary of such dense code.
If we keep adding layers of function calls, the code becomes cryptic:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(reduce * (filter odd? (map inc v)))
=&gt; 15</pre>
</div>
</div>
<div class="paragraph">
<p>With three layers of function calls, things are getting hard to keep in our head all at once.
This expression may be easier to mentally process by starting from the innermost map, working out to filter, and then out to reduce last.
But that is the opposite of our reading direction and locating the true starting point is difficult.</p>
</div>
<div class="paragraph">
<p>The presentation of sequence operations is clearer if you name intermediary results:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(let [incs (map inc v)
      odd-incs (filter odd? incs)]
  (reduce * odd-incs))
=&gt; 15</pre>
</div>
</div>
<div class="paragraph">
<p>Or use a thread last:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(-&gt;&gt; v
    (map inc)
    (filter odd?)
    (reduce *))
=&gt; 15</pre>
</div>
</div>
<div class="paragraph">
<p>Threading is good for unwrapping deeply nested function calls, or avoiding naming intermediary steps that don&#8217;t have a natural name.</p>
</div>
<div class="paragraph">
<p>Thread first is similar, but passes the value in the first position</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(-&gt; 42 (/ 2) (inc))
=&gt; 22</pre>
</div>
</div>
<div class="paragraph">
<p>Note that for empty expressions, the parenthesis are optional.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(-&gt; 42 (/ 2) inc)
=&gt; 22</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_data_structures_are_functions">6.5. Data structures are functions!</h3>
<div class="paragraph">
<p>Maps sets vectors and keywords are functions.
They delegate to get.
While it is possible to use get to access collections, calling the collection directly is more common.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(get {:a 1 :b 2} :a)
=&gt; 1</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>({:a 1 :b 2} :a)
=&gt; 1</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(:a {:a 1 :b 2})
=&gt; 1</pre>
</div>
</div>
<div class="paragraph">
<p>This is useful because you don&#8217;t need to create a function to call get.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(map (fn [m] (get m :a)) [{:a 1} {:a 2} {:a 3}])
=&gt; (1 2 3)</pre>
</div>
</div>
<div class="paragraph">
<p>Can instead be written as:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(map :a [{:a 1} {:a 2} {:a 3}])
=&gt; (1 2 3)</pre>
</div>
</div>
<div class="paragraph">
<p>Where we are looking up the value associated with :a for each element in a vector of maps.</p>
</div>
<div class="paragraph">
<p>Sets implement get:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(get #{1 2 3} 2)
=&gt; 2</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(#{1 2 3} 2)
=&gt; 2</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(remove #{nil "bad"} [:a nil :b "bad" "good"])</pre>
</div>
</div>
<div class="paragraph">
<p>And so do vectors:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(get [1 2 3] 0)
=&gt; 1</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>([1 2 3] 0)
=&gt; 1</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_exercises_6">6.6. Exercises</h3>
<div class="ulist">
<ul>
<li>
<p>Write a function that takes two inputs, and returns the sum of the numbers in a range between two input integers, including the two input numbers.</p>
</li>
<li>
<p>Write a function that produces a sequence of powers of 2: (1 2 4 8 16 …)</p>
</li>
<li>
<p>Write a function that takes a string and produces a sequence of characters with no vowels.</p>
</li>
<li>
<p>Write a function that produces a sequence: (1 ½ ⅓ ¼ …)</p>
</li>
<li>
<p>Write a function that produces a sequence: (1  ½ ¼ ⅛ …)</p>
</li>
<li>
<p>Write a function that produces the Fibonacci sequence (1 1 2 3 5 8 13 21)</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_answers_6">6.7. Answers</h3>
<div class="literalblock">
<div class="content">
<pre>(defn sum-between [a b]
  (apply + (range a (inc b))))
(sum-between 3 5)
=&gt; 12</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn powers-of [n]
  (iterate #(* % n) 1))
(take 5 (powers-of 2))
=&gt; (1 2 4 8 16)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn shorten [s]
  (remove #{\a \e \i \o \u} s))
(apply str (shorten "Clojure sets are functions"))
=&gt; "Cljr sts r fnctns"</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn fractions []
  (map / (repeat 1) (rest (range))))
(take 5 (fractions))
=&gt; (1 1/2 1/3 1/4 1/5)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn fraction-powers [n]
  (map / (repeat 1) (powers-of n)))
(take 5 (fraction-powers 2))
=&gt; (1 1/2 1/4 1/8 1/16)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn fib-step [[a b]]
  [b (+ a b)])
(defn fib-seq []
  (map first (iterate fib-step [1 1])))
(take 10 (fib-seq))
=&gt; (1 1 2 3 5 8 13 21 34 55)</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_challenge_2_processing_files">Challenge 2: Processing files</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Insuricorp branches collect applications for the “corgi cover” policy and periodically send them to headquarters in a large comma separated text file.
You have been tasked with processing the files using the validation logic you built earlier.</p>
</div>
<div class="sect2">
<h3 id="_part_1_2">Part 1:</h3>
<div class="paragraph">
<p>Create a function that opens a file called corgi-cover-applications.csv and converts every row into a data structure and prints it.
Next use that data structure as an input to your validation function and print the result.
See <code>slurp</code> <code>line-seq</code> <code>clojure.string/split</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_part_2_2">Part 2:</h3>
<div class="paragraph">
<p>The downstream Insuricorp systems will only be operating on corgi cover applications that pass your eligibility check.
But the invalid corgi cover applications need to be sent back to the branches so that they can follow up with the customers on why they are not eligible.
Create a new function that opens two output files and writes to them based upon your eligibility check.
The files should be called <code>eligible-corgi-cover-applications.csv</code> and <code>ineligible-corgi-cover-applications.csv</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_part_3_2">Part 3:</h3>
<div class="paragraph">
<p>A request has come in from several Insuricorp branches that if a person is ineligible for corgi cover, a short reason be supplied.
That way the sales reps don&#8217;t have to spend time figuring out what they need to tell the customer.
Create a new validation function that instead of returning a boolean, returns nil if no problems are found, or returns a string with the reason if a problem is found.
Create a new processing function that splits the applications into two files based on the new validator.</p>
</div>
</div>
<div class="sect2">
<h3 id="_part_4_2">Part 4:</h3>
<div class="paragraph">
<p>As part of the Megacorp merger, the downstream systems are converting to JSON format.
Create a new function that writes JSON data to an <code>eligible-corgi-cover-applications.json</code> file.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_macros">7. Macros</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
I never think about myself as an artist working in this time. I think about it in macro.
</blockquote>
<div class="attribution">
&#8212; Frank Ocean
</div>
</div>
<div class="paragraph">
<p>Macros manipulate the operand forms instead of evaluating them as input arguments.
They are not functions, and cannot be used as values or arguments to functions.
We already used a macro; defn is a macro for conveniently defining functions.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn square [x] (* x x))</pre>
</div>
</div>
<div class="paragraph">
<p>Actually expands to a def and fn form:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(def square (fn [x] (* x x)))</pre>
</div>
</div>
<div class="paragraph">
<p>The difference between macros and functions is that macro arguments are manipulated at compile time instead of evaluated.
Macros allow the user to extend the syntax of Clojure, but macros are less useful than functions as they cannot be used as values or arguments to higher order functions.</p>
</div>
<div class="sect2">
<h3 id="_expanding_macros">7.1. Expanding macros</h3>
<div class="paragraph">
<p>Macros provide syntactic sugar.
Macros first expand to produce new code that then gets compiled.
The form is expanded at compile time through manipulation of the form.
You can examine the expansion using <code>macroexpand-1</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(macroexpand-1 '(defn square [x] (* x x)))
=&gt; (def my-namespace/square
     (clojure.core/fn
       ([my-namespace/x]
        (clojure.core/* my-namespace/x my-namespace/x))))</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_defining_macros">7.2. Defining macros</h3>
<div class="paragraph">
<p>Consider two different definitions of zen:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defmacro zen1 [x]
  (println "x:" x) x)</pre>
</div>
</div>
<div class="paragraph">
<p>and</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn zen2 [x]
  (println "x:" x) x)</pre>
</div>
</div>
<div class="paragraph">
<p>Now call</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(zen1 (+ 1 2))
=&gt; x:(+ 1 2)
3</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(zen2 (+ 1 2))
=&gt; x:3
3</pre>
</div>
</div>
<div class="paragraph">
<p>The final result is the same, but notice that the input to <code>zen1</code> was a list, where as the input to <code>zen2</code> was the result of evaluating the list.
That&#8217;s the key difference between a macro and a function.</p>
</div>
<div class="paragraph">
<p>Macros themselves are really just functions with a <code>:macro</code> flag set in their metadata, which causes them to be passed in the input forms unevaluated, and caused the result to be evaluated.
This last part is less obvious&#8230;&#8203; but think back to <code>zen1</code>&#8230;&#8203; <code>x</code> was a list, we returned <code>x</code>, but the final result wasn&#8217;t a list&#8230;&#8203; it was <code>3</code>.
The list was evaluated as a function call to <code>+</code>, resulting in <code>3</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_syntax_quoting">7.3. Syntax quoting</h3>
<div class="paragraph">
<p>To help write macros there is a special quoting form called syntax-quote.</p>
</div>
<div class="paragraph">
<p>Back-quote (<code>`</code>) Unquote (<code>~</code>) and Unquote-splicing (<code>~@</code>)</p>
</div>
<div class="literalblock">
<div class="content">
<pre>'(1 2 ~(+ 1 2) ~@(map inc [3 4 5]))
=&gt; (1 2 3 4 5 6)</pre>
</div>
</div>
<div class="paragraph">
<p>All symbols in a syntax-quote form get fully qualified.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>`(inc 1)
=&gt; (clojure.core/inc 1)</pre>
</div>
</div>
<div class="paragraph">
<p>Fully qualified symbols is desirable when creating macros, otherwise symbols may have another meaning in the context that the macro is expanded in:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defmacro m1 []
  '(inc 1))
(defmacro m2 []
  `(inc 1))
(let [inc dec]
  {:m1 (m1)
   :m2 (m2)})
=&gt; {:m1 0, :m2 2}</pre>
</div>
</div>
<div class="paragraph">
<p>Within the <code>let</code> block, the symbol <code>inc</code> has a different meaning than normal.
Because <code>m2</code> uses syntax quote, <code>inc</code> gets fully qualified to <code>clojure.core/inc</code> which does not collide with the <code>let</code> binding.</p>
</div>
<div class="paragraph">
<p>Fully qualified symbols avoids one source of collisions, but there is another:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defmacro bad [expr]
  (list 'let '[a 1]
    (list 'inc expr)))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(bad 0)
=&gt; 1</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(def a 0)
(bad a)
=&gt; 2</pre>
</div>
</div>
<div class="paragraph">
<p>This might seem confusing, unless you notice that:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(macroexpand-1 '(bad a))
=&gt; (let [a 1] (inc a))</pre>
</div>
</div>
<div class="paragraph">
<p>Instead of inc operating on the input parameter, it is operating on an internal let bound value.
To avoid this situation Clojure provides a let gensyms form which will produce a randomly named binding:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defmacro good [expr]
  `(let [a# 1]
     (inc ~expr)))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(good a)
=&gt; 1</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(good 0)
=&gt; 1</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(macroexpand-1 '(good a))
=&gt; (clojure.core/let [a__6500__auto__ 1] (clojure.core/inc a))</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>let</code> binding <code>a#</code> expands out to a randomly generated symbol unlikely to collide with existing symbols.</p>
</div>
</div>
<div class="sect2">
<h3 id="_code_as_data">7.4. Code as data</h3>
<div class="paragraph">
<p>You may have noticed when we write a macro, we are really writing a function that produces code.
The output is code… as data, and we manipulate code… as data.
Homoiconic means that the language text has the same structure as its abstract syntax tree (AST).
This allows all code in the language to be accessed and transformed as data, using the same representation.
Nested code is well represented as a data structure.</p>
</div>
<div class="paragraph">
<p>When working on a non-trivial macro a good strategy is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Step 1: Write a function!</p>
</li>
<li>
<p>Step 2: Call your function from the macro.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Stated another way; keep the macro as small as possible, and offload transformations to functions.</p>
</div>
</div>
<div class="sect2">
<h3 id="_exercises_7">7.5. Exercises</h3>
<div class="paragraph">
<p>Create the following macros and test cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a macro called ignore which accepts any number of expressions, does absolutely nothing, and always returns <code>nil</code>.</p>
<div class="literalblock">
<div class="content">
<pre>(ignore (println "hello???") (inc 42))</pre>
</div>
</div>
</li>
<li>
<p>Define your own version of the when macro. When is like if, but only has one branch and allows multiple statements.</p>
<div class="literalblock">
<div class="content">
<pre>(when2 (pos? x)
  (println "Positive:" x)
  (inc x))</pre>
</div>
</div>
</li>
<li>
<p>Write a spy macro. Spy wraps an expression and prints out its value.</p>
<div class="literalblock">
<div class="content">
<pre>(* (spy (+ 1 2)) 3)
=&gt; Expression (+ 1 2) has value 3
   9</pre>
</div>
</div>
</li>
<li>
<p>Write your own version of the <code>or</code> macro</p>
<div class="literalblock">
<div class="content">
<pre>(or2 (pos? 1) (println "does not execute"))</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_answers_7">7.6. Answers</h3>
<div class="literalblock">
<div class="content">
<pre>(defmacro ignore  [expr]  nil)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(defmacro when2 [test &amp; body]
  (list 'if test (cons 'do body))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(defmacro spy [expr]
  `(let [result# ~expr]
     (println "Expression" '~expr "has value" result#)
     result#))
(macroexpand-1 '(spy (* 2 3)))
=&gt; (clojure.core/let [result__6418__auto__ (* 2 3)]
     (clojure.core/println
       "Expression" (quote (* 2 3))
       "has value" result__6418__auto__)
     result__6418__auto__)
(+ 1 (spy (* 2 3)))
=&gt; Expression (* 2 3) has value 6
   7</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(defmacro or2
  ([] nil)
  ([x] x)
  ([x &amp; next]
      `(let [or# ~x]
         (if or# or# (or ~@next)))))</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_parallel_programming_and_concurrency">8. Parallel Programming and Concurrency</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
Our moral traditions developed concurrently with our reason, not as its product.
</blockquote>
<div class="attribution">
&#8212; Friedrich August von Hayek
</div>
</div>
<div class="sect2">
<h3 id="_vars_and_dynamic_scope">8.1. Vars and dynamic scope</h3>
<div class="paragraph">
<p>Vars are automatically derefed when evaluated, so it can seem like they are just a variable.
But you can “see” the var itself using the var function or #' shorthand.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(def one-hundred 100)
=&gt; #'training.core-test/one-hundred</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(var one-hundred)
=&gt; #'training.core-test/one-hundred</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(deref #'one-hundred)
=&gt; 100</pre>
</div>
</div>
<div class="paragraph">
<p>The most common reason you would want to do that is to examine the metadata of a var:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(meta #'one-hundred)
=&gt; {:line 73, :column 1, ...}</pre>
</div>
</div>
<div class="paragraph">
<p>Metadata may be provided using <code>^{}</code></p>
</div>
<div class="literalblock">
<div class="content">
<pre>(def x ^{:private true} 1)</pre>
</div>
</div>
<div class="paragraph">
<p>You can attach whatever metadata you wish.
These are the keys the compiler looks for:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>:private
:doc
:author
:type</pre>
</div>
</div>
<div class="paragraph">
<p>By default Vars are static.
But Vars can be marked as dynamic to allow per-thread bindings.
Within each thread they obey a stack discipline:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(def ^:dynamic x 1)
(def ^:dynamic y 1)
(+ x y)
=&gt; 2</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(binding [x 2 y 3]
         (+ x y))
=&gt; 5</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(+ x y)
=&gt; 2</pre>
</div>
</div>
<div class="paragraph">
<p>Bindings created with binding cannot be seen by any other thread.
Likewise, bindings created with binding can be assigned to, which provides a means for a nested context to communicate with code before it on the call stack.
This capability is opt-in only by setting a metadata tag: dynamic to true as in the code block above.</p>
</div>
<div class="paragraph">
<p>Functions defined with defn are stored in Vars, allowing for the re-definition of functions in a running program.
This also enables many of the possibilities of aspect- or context-oriented programming.
For instance, you could wrap a function with logging behavior only in certain call contexts or threads.</p>
</div>
</div>
<div class="sect2">
<h3 id="_delays_futures_and_promises">8.2. Delays, Futures, and Promises</h3>
<div class="sect3">
<h4 id="_delays">8.2.1. Delays</h4>
<div class="paragraph">
<p>Delays wrap an arbitrary body of code for evaluation at a later stage so that the code in question is not run unless the answer is asked for.
Delays also cache the result value to prevent another execution.
The body code will only run once, even if dereferenced concurrently.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(def d (delay (println "Hello world!") 42))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>d
=&gt; #object[clojure.lang.Delay {:status :pending, :val nil}]</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(realized? d)
=&gt; false</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>@d
=&gt; Hello world!
   42</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>@d
=&gt; 42</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(realized? d)
=&gt; true</pre>
</div>
</div>
<div class="paragraph">
<p>We assign the delay to a var called <code>d</code>.
We see that it starts in a pending state.
Dereferencing <code>d</code> with <code>@</code> causes the code to run, printing <code>"Hello world!"</code> and returning <code>42</code>.
Notice that the second dereference with <code>@</code> does not print <code>"Hello world!"</code> again, it only returns the already realized value of <code>42</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_futures">8.2.2. Futures</h4>
<div class="paragraph">
<p>Futures provide an easy way to spin off a new thread to do some computation or I/O that you will need access to in the future.
The call style is compatible with delay.
The difference is that the work begins immediately on another thread.
The flow of control is not blocked.
If you dereference a future, it will block until the value is available:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(def f
  (future (Thread/sleep 10000) 42))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>f
=&gt; #object[clojure.core$future_call {:status :pending, :val nil}]</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(realized? f)
=&gt; false</pre>
</div>
</div>
<div class="paragraph">
<p>--- 10 seconds pass ---</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(realized? f)
=&gt; true</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>@f
=&gt; 42</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>f
#object[clojure.core$future_call {:status :ready, :val 42}]</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_promises">8.2.3. Promises</h4>
<div class="paragraph">
<p>Promises are used in a similar way to delay or future in that you dereference them for a value, can check if they have a value with <code>realized?</code> and they block when you dereference them if they don&#8217;t have a value until they do.
Where they differ is that you don&#8217;t immediately give them a value, but provide them with one by calling deliver:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(def p (promise))
(realized? p)
=&gt; false</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(deliver p "as-promised")
(realized? p)
=&gt; true</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>@p
=&gt; "as-promised"</pre>
</div>
</div>
<div class="paragraph">
<p>Dereferencing works on futures, delays, promises, atoms, agents refs and vars.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_atoms_refs_and_agents">8.3. Atoms, Refs, and Agents</h3>
<div class="paragraph">
<p>Atoms provide a way to manage shared, synchronous, independent state.
They are a reference type like refs and vars.
You create an atom with atom, and can access its state with <code>deref</code>/<code>@</code>.
Like refs and agents, atoms support validators.
To change the value of an atom, you can use <code>swap!</code>.
A lower-level <code>compare-and-set!</code> is also provided.
Changes to atoms are always free of race conditions.</p>
</div>
<div class="paragraph">
<p>As with all reference types, the intended use of atom is to hold one of Clojure&#8217;s immutable data structures.
And, similar to ref&#8217;s alter and agent&#8217;s send, you change the value by applying a function to the old value.
This is done in an atomic manner by <code>swap!</code> Internally, <code>swap!</code> reads the current value, applies the function to it, and attempts to <code>compare-and-set!</code> it in.
Since another thread may have changed the value in the intervening time, it may have to retry, and does so in a spin loop.
The net effect is that the value will always be the result of the application of the supplied function to a current value, atomically.
However, because the function might be called multiple times, it must be free of side effects.</p>
</div>
<div class="paragraph">
<p>Atoms are an efficient way to represent some state that will never need to be coordinated with any other, and for which you wish to make synchronous changes (unlike agents, which are similarly independent but asynchronous).</p>
</div>
<div class="paragraph">
<p>While Vars ensure safe use of mutable storage locations via thread isolation, transactional references (Refs) ensure safe shared use of mutable storage locations via a software transactional memory (STM) system.
Refs are bound to a single storage location for their lifetime, and only allow mutation of that location to occur within a transaction.
In practise Refs are rarely used.</p>
</div>
<div class="paragraph">
<p>Like Refs, Agents provide shared access to mutable state.
Where Refs support coordinated, synchronous change of multiple locations, Agents provide independent, asynchronous change of individual locations.
Agents are bound to a single storage location for their lifetime, and only allow mutation of that location (to a new state) to occur as a result of an action.
Actions are functions (with, optionally, additional arguments) that are asynchronously applied to an Agent&#8217;s state and whose return value becomes the Agent&#8217;s new state.
Because actions are functions they can also be multimethods and therefore actions are potentially polymorphic.
Also, because the set of functions is open, the set of actions supported by an Agent is also open, a sharp contrast to pattern matching message handling loops provided by some other languages.</p>
</div>
<div class="paragraph">
<p>Clojure&#8217;s Agents are reactive, not autonomous - there is no imperative message loop and no blocking receive.
The state of an Agent should be itself immutable (preferably an instance of one of Clojure&#8217;s persistent collections), and the state of an Agent is always immediately available for reading by any thread (using the deref function or reader macro @) without any messages, i.e. observation does not require cooperation or coordination.</p>
</div>
<div class="paragraph">
<p>Agent action dispatches take the form (send agent fn args*).
send (and send-off) always returns immediately.
At some point later, in another thread, the following will happen:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The given fn will be applied to the state of the Agent and the args, if any were supplied.
The return value of the given fn will become the new state of the Agent.</p>
</li>
<li>
<p>If any watchers were added to the Agent, they will be called.
See add-watch for details.</p>
</li>
<li>
<p>If during the function execution any other dispatches are made (directly or indirectly), they will be held until after the state of the Agent has been changed.</p>
</li>
<li>
<p>If any exceptions are thrown by an action function, no nested dispatches will occur, and the exception will be cached in the Agent itself.
When an Agent has errors cached, any subsequent interactions will immediately throw an exception, until the agent&#8217;s errors are cleared.
Agent errors can be examined with agent-error and the agent restarted with restart-agent.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The actions of all Agents get interleaved amongst threads in a thread pool.
At any point in time, at most one action for each Agent is being executed.
Actions dispatched to an agent from another single agent or thread will occur in the order they were sent, potentially interleaved with actions dispatched to the same agent from other sources.
send should be used for actions that are CPU limited, while send-off is appropriate for actions that may block on IO.</p>
</div>
<div class="paragraph">
<p>Agents are integrated with the STM - any dispatches made in a transaction are held until it commits, and are discarded if it is retried or aborted.
No user-code locking is involved.</p>
</div>
<div class="paragraph">
<p>Note that use of Agents starts a pool of non-daemon background threads that will prevent shutdown of the JVM.
Use shutdown-agents to terminate these threads and allow shutdown.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_java_interop">9. Java Interop</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
Sitting in my favorite coffeehouse with a new notebook and a hot cup of java is my idea of Heaven.
</blockquote>
<div class="attribution">
&#8212; Libba Bray
</div>
</div>
<div class="sect2">
<h3 id="_clojure_syntax_for_java_constructors">9.1. Clojure syntax for Java constructors</h3>
<div class="paragraph">
<p>Constructing a Java object is done by appending a period to the class identifier:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(ns training.core
  (:import [java.util Date]))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(Date.)
(Date. 2018 02 17)</pre>
</div>
</div>
<div class="paragraph">
<p>Which is equivalent to the less used variant:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(new Date)
(new Date 2018 02 17)</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_calling_methods">9.2. Calling methods</h3>
<div class="paragraph">
<p>Calling a method on a Java object done by prepending a leading period:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(.length "hello world")
(.isDirectory (java.io.File. "my-dir"))</pre>
</div>
</div>
<div class="paragraph">
<p>Which is equivalent to the less used variant:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(. "hello world" length)
(. (java.io.File. "my-dir") isDirectory)</pre>
</div>
</div>
<div class="paragraph">
<p>Java static method calls are accessed by slash:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(Math/pow 1 2)
(.print System/out "hi")</pre>
</div>
</div>
<div class="paragraph">
<p>Inner classes can be accessed using the dollar symbol:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>java.nio.channels.FileChannel$MapMode/READ_ONLY</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_reify">9.3. reify</h3>
<div class="paragraph">
<p><code>reify</code> creates an object that conforms to an interface:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(.listFiles (java.io.File. ".")
  (reify
    java.io.FileFilter
    (accept [this f]
      (.isDirectory f))))</pre>
</div>
</div>
<div class="paragraph">
<p>Notice that we didn&#8217;t define a class? We directly created an object that conforms to the <code>FileFilter</code> interface.
<code>reify</code> is a convenient way to provide a concrete implementation of an interface.</p>
</div>
</div>
<div class="sect2">
<h3 id="_gen_class_and_proxy">9.4. gen-class and proxy</h3>
<div class="paragraph">
<p><code>gen-class</code> creates a class.
In practice the need to create a class from within Clojure is rare, so we won&#8217;t be covering the syntax.
(see <a href="https://kotka.de/blog/2010/02/gen-class_how_it_works_and_how_to_use_it.html" class="bare">https://kotka.de/blog/2010/02/gen-class_how_it_works_and_how_to_use_it.html</a> if you want to explore this further)</p>
</div>
<div class="paragraph">
<p><code>proxy</code> can be used to extend a concrete superclass.
Again the need for this is rare.
(see <a href="https://kotka.de/blog/2010/03/proxy_gen-class_little_brother.html" class="bare">https://kotka.de/blog/2010/03/proxy_gen-class_little_brother.html</a> if you want to explore this further)</p>
</div>
</div>
<div class="sect2">
<h3 id="_including_java_classes_in_clojure_projects">9.5. Including Java classes in Clojure projects</h3>
<div class="paragraph">
<p>You can define Java classes in Java in a separate directory and add</p>
</div>
<div class="literalblock">
<div class="content">
<pre>:java-source-paths ["src/java"]</pre>
</div>
</div>
<div class="paragraph">
<p>To your <code>project.clj</code> file
(See <a href="https://github.com/technomancy/leiningen/blob/master/doc/MIXED_PROJECTS.md" class="bare">https://github.com/technomancy/leiningen/blob/master/doc/MIXED_PROJECTS.md</a> for more other options.)</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_challenge_3_mocking_parallel_web_requests">10. Challenge 3: Mocking parallel web requests</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Insuricorp and Megacorp are integrating their IT systems.
As part of this effort you need to modify the “Corgi cover” eligibility logic to call a remote web service.
Your task is to set up the code and tests.</p>
</div>
<div class="sect2">
<h3 id="_part_1_mock_a_web_request">10.1. Part 1: Mock a web request</h3>
<div class="paragraph">
<p>Every Insuricorp “Corgi cover” policy application needs to be cross referenced with Megacorp to see if the customer has a Megacorp policy already via a remote web service.
The web service is not available for you to test against yet.
Set up a function called fetch-megacorp-policies to do the web request but leave the implementation empty.
Create a test that changes the behavior of fetch-megacorp-policies to behave as though it were a web request; make it pause for 100ms before returning the policies that the person has.
Set up a test that exercises the eligibility checks using the mocked version of a web request.</p>
</div>
</div>
<div class="sect2">
<h3 id="_part_2_report_the_how_long_it_takes">10.2. Part 2: Report the how long it takes</h3>
<div class="paragraph">
<p>In Java you might write something like this:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>long startTime = System.nanoTime();
// ... the code being measured ...
long estimatedTime = System.nanoTime() - startTime;</pre>
</div>
</div>
<div class="paragraph">
<p>Implement a similar solution in Clojure.</p>
</div>
</div>
<div class="sect2">
<h3 id="_part_3_make_parallel_requests">10.3. Part 3: Make parallel requests</h3>
<div class="paragraph">
<p>The web service you are using can handle multiple requests faster than a series of requests.
It operates fastest with up to 20 connections.
Modify your code such that multiple requests are made simultaneously.
Compare the timing results to confirm the operations are happening in parallel.</p>
</div>
</div>
<div class="sect2">
<h3 id="_part_4_error_handling">10.4. Part 4: Error handling</h3>
<div class="paragraph">
<p>Modify your mock of fetch-megacorp-policies such that it throws an exception randomly about 10% of the time.
Make sure your tests report a failure.
Now update your logic to handle the errors and retry up to 10 times.
The tests should pass.
Then create another test where the exception is thrown 100% of the time, and the max tries occurs.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_polymorphism_and_types">11. Polymorphism and Types</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_multimethods">11.1. Multimethods</h3>
<div class="paragraph">
<p>Polymorphic dispatch.
First we define the name of the multimethod, and the dispatch function:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defmulti encounter
  (fn dispatch [x y]
    [(:species x) (:species y)]))</pre>
</div>
</div>
<div class="paragraph">
<p>In this case the dispatch function returns a vector pair of the species of input <code>x</code> and the species of input <code>y</code>.
Now we can provide methods implementing functions to execute for a given dispatch value:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defmethod encounter [:bunny :lion] [x y] :run-away)
(defmethod encounter [:lion :bunny] [x y] :eat)
(defmethod encounter [:lion :lion] [x y] :fight)
(defmethod encounter [:bunny :bunny] [x y] :mate)</pre>
</div>
</div>
<div class="paragraph">
<p>These are somewhere between a case statement and a function definition.
They give the conditions under which to be called, and a function definition.
Given a dispatch result of <code>[:bunny :lion]</code>, the first method will be called on the <code>x</code> and <code>y</code> inputs, and the method here does nothing but return a value <code>:run-away</code>.
Let&#8217;s set up some test inputs:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(def bunny1 {:species :bunny, :other :stuff})
(def bunny2 {:species :bunny, :other :stuff})
(def lion1 {:species :lion, :other :stuff})
(def lion2 {:species :lion, :other :stuff})</pre>
</div>
</div>
<div class="paragraph">
<p>Now we can call encounter on the data to see what it does&#8230;&#8203;</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(encounter bunny1 bunny2)
=&gt; :mate
(encounter bunny1 lion1)
=&gt; :run-away
(encounter lion1 bunny1)
=&gt; :eat
(encounter lion1 lion2)
=&gt; :fight</pre>
</div>
</div>
<div class="paragraph">
<p>Because keywords are functions, it&#8217;s quite common to use a keyword as a dispatch function.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defmulti draw :shape)</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_protocols">11.2. Protocols</h3>
<div class="paragraph">
<p>A protocol is a named set of named methods and their signatures, defined using defprotocol:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defprotocol AProtocol
  "A doc string for AProtocol abstraction"
  (bar [a b] "bar docs")
  (baz [a] [a b] [a b c] "baz docs"))</pre>
</div>
</div>
<div class="paragraph">
<p>No implementations are provided.
Docs can be specified for the protocol and the functions.
The above yields a set of polymorphic functions and a protocol object.
All are namespace-qualified by the namespace enclosing the definition.</p>
</div>
<div class="paragraph">
<p>The resulting functions dispatch on the type of their first argument, and thus must have at least one argument.
defprotocol is dynamic, and does not require AOT compilation.
defprotocol will automatically generate a corresponding interface, with the same name as the protocol, e.g. given a protocol my.ns/Protocol, an interface my.ns.Protocol.
The interface will have methods corresponding to the protocol functions, and the protocol will automatically work with instances of the interface.</p>
</div>
<div class="paragraph">
<p>Note that you do not need to use this interface with deftype, defrecord, or reify, as they support protocols directly:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defprotocol P
  (foo [x])
  (bar-me [x] [x y]))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(deftype Foo [a b c]
  P
  (foo [x] a)
  (bar-me [x] b)
  (bar-me [x y] (+ c y)))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(bar-me (Foo. 1 2 3) 42)
=&gt; 45</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(foo
 (let [x 42]
   (reify P
     (foo [this] 17)
     (bar-me [this] x)
     (bar-me [this y] x))))
=&gt; 17</pre>
</div>
</div>
<div class="paragraph">
<p>A Java client looking to participate in the protocol can do so most efficiently by implementing the protocol-generated interface.
External implementations of the protocol (which are needed when you want a class or type not in your control to participate in the protocol) can be provided using the extend construct:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(extend AType
  AProtocol
   {:foo an-existing-fn
    :bar (fn [a b] ...)
    :baz (fn ([a]...) ([a b] ...)...)}
  BProtocol
    {...}
...)</pre>
</div>
</div>
<div class="paragraph">
<p><code>extend</code> takes a type/class (or interface, see below), a one or more protocol + function map (evaluated) pairs.
Will extend the polymorphism of the protocol&#8217;s methods to call the supplied functions when an AType is provided as the first argument.
Function maps are maps of the keywordized method names to ordinary fns.
This facilitates easy reuse of existing fns and maps, for code reuse/mixins without derivation or composition.</p>
</div>
<div class="paragraph">
<p>You can implement a protocol on an interface.
This is primarily to facilitate interop with the host (e.g. Java) but opens the door to incidental multiple inheritance of implementation since a class can inherit from more than one interface, both of which implement the protocol.
If one interface is derived from the other, the more derived is used, else which one is used is unspecified.</p>
</div>
<div class="paragraph">
<p>The implementing <code>fn</code> can presume first argument is instanceof <code>AType</code>.
You can implement a protocol on <code>nil</code>.
To define a default implementation of protocol (for other than <code>nil</code>) just use <code>Object</code>.
Protocols are fully reified and support reflective capabilities via <code>extends?</code>, <code>extenders</code>, and <code>satisfies?</code>.
Note the convenience macros <code>extend-type</code>, and <code>extend-protocol</code>.</p>
</div>
<div class="paragraph">
<p>If you are providing external definitions inline, these will be more convenient than using extend directly</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(extend-type MyType
  Countable
    (cnt [c] ...)
  Foo
    (bar [x y] ...)
    (baz ([x] ...) ([x y zs] ...)))</pre>
</div>
</div>
<div class="paragraph">
<p>Expands into:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(extend MyType
  Countable
   {:cnt (fn [c] ...)}
  Foo
   {:baz (fn ([x] ...) ([x y zs] ...))
    :bar (fn [x y] ...)})</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_types_with_defrecord_and_deftype">11.3. Creating types with defrecord and deftype</h3>
<div class="paragraph">
<p><code>deftype</code>, <code>defrecord</code>, and <code>reify</code> provide the mechanism for defining implementations of abstractions, and instances of those implementations.
Resist the urge to use them to define 'structured data' as you would define classes or structures in other languages.
It is preferred to use the built-in datatypes (vectors, maps, sets) to represent structured data.</p>
</div>
<div class="sect3">
<h4 id="_deftype">11.3.1. Deftype</h4>
<div class="literalblock">
<div class="content">
<pre>(deftype Circle [radius])
(deftype Square [length width])</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(Circle. 10)
(Square. 5 11)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(-&gt;Circle 10)
(-&gt;Square 5 11)</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_defrecord">11.3.2. Defrecord</h4>
<div class="paragraph">
<p>This example shows how to implement a Java interface in defrecord.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(import java.net.FileNameMap)</pre>
</div>
</div>
<div class="paragraph">
<p>To define a record named <code>Thing</code> with a single field <code>a</code>, implement <code>FileNameMap</code> interface and provide an implementation for the single method: <code>String getContentTypeFor(String fileName)</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defrecord Thing [a]
  FileNameMap
  (getContentTypeFor [this fileName] (str a "-" fileName)))</pre>
</div>
</div>
<div class="paragraph">
<p>Construct an instance of the record:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(def thing (Thing. "foo"))</pre>
</div>
</div>
<div class="paragraph">
<p>Check that the instance implements the interface:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(instance? FileNameMap thing)</pre>
</div>
</div>
<div class="paragraph">
<p>Call the method on the <code>thing</code> instance and pass <code>"bar"</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(.getContentTypeFor thing "bar")</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_specifications_with_clojure_spec">11.4. Specifications with clojure.spec</h3>
<div class="paragraph">
<p>The spec library specifies the structure of data, validates or destructures it, and can generate data based on the spec.
Spec was introduced into Clojure 1.9.0, so update your <code>project.clj</code> to the right version:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[org.clojure/clojure "1.9.0"]</pre>
</div>
</div>
<div class="paragraph">
<p>To start working with spec, require the <code>clojure.spec.alpha</code> namespace at the REPL:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(ns my.ns
  (:require [clojure.spec.alpha :as s]))</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_validation">11.5. Validation</h3>
<div class="paragraph">
<p>Any function that takes a single argument and returns a truthy value is a valid predicate spec.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(s/valid? even? 10)
=&gt; true</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(s/valid? string? 0)
=&gt; false</pre>
</div>
</div>
<div class="paragraph">
<p>Sets are functions, so can be used as predicates that match one or more literal values:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(s/valid? #{:club :diamond :heart :spade} :club)
=&gt; true</pre>
</div>
</div>
<div class="paragraph">
<p>Specs are registered using <code>s/def</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(s/def ::suit #{:club :diamond :heart :spade})</pre>
</div>
</div>
<div class="paragraph">
<p>A registered spec identifier can be used in place of a spec definition.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(s/valid? ::suit :club)
=&gt; true</pre>
</div>
</div>
<div class="paragraph">
<p>The simplest way to compose specs is with <code>and</code> and <code>or</code>.
Let&#8217;s create a spec that combines several predicates into a composite spec with <code>s/and</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(s/def ::big-even (s/and int? even? #(&gt; % 1000)))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(s/valid? ::big-even 10)
=&gt; false</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(s/valid? ::big-even 100000)
=&gt; true</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_conforming">11.6. Conforming</h3>
<div class="paragraph">
<p>We can also use <code>s/or</code> to specify two alternatives:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(s/def ::name-or-id (s/or :name string? :id int?))</pre>
</div>
</div>
<div class="paragraph">
<p>This <code>or</code> spec is the first case we&#8217;ve seen that involves a choice during validity checking.
Each choice is annotated with a tag (here, between <code>:name</code> and <code>:id</code>) and those tags give the branches names that can be used to understand or enrich the data returned from conform and other spec functions.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(s/conform ::name-or-id "abc")
=&gt; [:name "abc"]</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(s/conform ::name-or-id 100)
=&gt; [:id 100]</pre>
</div>
</div>
<div class="paragraph">
<p>Many predicates that check an instance&#8217;s type do not allow nil as a valid value (<code>string?</code>, <code>number?</code>, <code>keyword?</code>, etc).
To include <code>nil</code> as a valid value, use the provided function nilable to make a spec:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(s/nilable string?)</pre>
</div>
</div>
<div class="paragraph">
<p>Explain can be used to report why a value does not conform to a spec.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(s/explain ::big-even 5)
=&gt; val: 5 fails spec: ::big-even predicate: even?</pre>
</div>
</div>
<div class="paragraph">
<p>In addition to <code>explain</code>, you can use <code>explain-str</code> to receive the error messages as a string or <code>explain-data</code> to receive the errors as data.</p>
</div>
</div>
<div class="sect2">
<h3 id="_maps">11.7. Maps</h3>
<div class="paragraph">
<p>Clojure programs rely heavily on passing around maps of data.
Entity maps in spec are defined with keys:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(def email-regex
  #"^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,63}$")
(s/def ::email-type (s/and string? #(re-matches email-regex %)))
(s/def ::acctid int?)
(s/def ::first-name string?)
(s/def ::last-name string?)
(s/def ::email ::email-type)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(s/def ::person (s/keys :req [::first-name ::last-name ::email]
                        :opt [::phone]))</pre>
</div>
</div>
<div class="paragraph">
<p>Validation checks that the required attributes are included, and that every registered key has a conforming value.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(s/valid? ::person
  {::first-name "Elon"
   ::last-name "Musk"
   ::email "elon@example.com"})
=&gt; true</pre>
</div>
</div>
<div class="paragraph">
<p>Much existing Clojure code does not use maps with namespaced keys and so keys can also specify <code>:req-un</code> and <code>:opt-un</code> for required and optional unqualified keys.
These variants specify namespaced keys used to find their specification, but the map only checks for the unqualified version of the keys.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(s/def :unq/person
  (s/keys :req-un [::first-name ::last-name ::email]
          :opt-un [::phone]))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(s/valid? :unq/person
  {:first-name "Elon"
   :last-name "Musk"
   :email "elon@example.com"})
=&gt; true</pre>
</div>
</div>
<div class="paragraph">
<p>In addition to the support for information maps via keys, spec also provides map-of for maps with homogenous key and value predicates.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(s/def ::scores (s/map-of string? int?))
(s/valid? ::scores {"Sally" 1000, "Joe" 500})
=&gt; true</pre>
</div>
</div>
<div class="paragraph">
<p>Spec has explicit support for pre and post conditions using <code>fdef</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn adder [x] #(+ x %))
(s/fdef adder
  :args (s/cat :x number?)
  :ret (s/fspec :args (s/cat :y number?)
                :ret number?)
  :fn #(= (-&gt; % :args :x) ((:ret %) 0)))</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>:ret</code> spec uses fspec to declare that the returning function takes and returns a number.
Even more interesting, the <code>:fn</code> spec can state a general property that relates the <code>:args</code> (where we know <code>x</code>) and the result we get from invoking the function returned from adder, namely that adding <code>0</code> to it should return <code>x</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_a_game_of_cards">11.8. A game of cards</h3>
<div class="paragraph">
<p>Here&#8217;s a bigger set of specs to model a game of cards:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(def suit? #{:club :diamond :heart :spade})
(def rank? (into #{:jack :queen :king :ace} (range 2 11)))
(def deck (for [suit suit? rank rank?] [rank suit]))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(s/def ::card (s/tuple rank? suit?))
(s/def ::hand (s/* ::card))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(s/def ::name string?)
(s/def ::score int?)
(s/def ::player (s/keys :req [::name ::score ::hand]))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(s/def ::players (s/* ::player))
(s/def ::deck (s/* ::card))
(s/def ::game (s/keys :req [::players ::deck]))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(def kenny
  {::name "Kenny Rogers"
   ::score 100
   ::hand []})
(s/valid? ::player kenny)
=&gt; true</pre>
</div>
</div>
<div class="paragraph">
<p>Bad data produces errors</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(s/explain ::game
  {::deck deck
   ::players [{::name "Kenny Rogers"
               ::score 100
               ::hand [[2 :banana]]}]})
=&gt; In: [::players 0 ::hand 0 1]
   val: :banana fails spec: ::card
   at: [::players ::hand 1]
   predicate: suit?</pre>
</div>
</div>
<div class="paragraph">
<p>If we have a function deal that doles out some cards to the players we can spec that function to verify the arg and return value are both suitable data values.
We can also specify a :fn spec to verify that the count of cards in the game before the deal equals the count of cards after the deal.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn total-cards [{:keys [::deck ::players] :as game}]
  (apply + (count deck)
    (map #(-&gt; % ::hand count) players)))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn deal [game] ...)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(s/fdef deal
  :args (s/cat :game ::game)
  :ret ::game
  :fn #(= (total-cards (-&gt; % :args :game))
          (total-cards (-&gt; % :ret))))</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_generators">11.9. Generators</h3>
<div class="paragraph">
<p>A key design constraint of spec is that all specs are also designed to act as generators of sample data that conforms to the spec (a critical requirement for property-based testing).</p>
</div>
<div class="paragraph">
<p>Spec generators rely on the Clojure property testing library test.check.
However, this dependency is dynamically loaded and you can use the parts of spec other than gen, exercise, and testing without declaring test.check as a runtime dependency.
When we wish to use these parts of spec (typically during testing), we need to declare a dev dependency on <code>test.check</code> in our <code>project.clj</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>:profiles {:dev {:dependencies [[org.clojure/test.check "0.9.0"]]}}</pre>
</div>
</div>
<div class="paragraph">
<p>The dev profile dependencies are included during testing but not published as a dependency or included in uber jars.</p>
</div>
<div class="paragraph">
<p>We require <code>clojure.spec.gen.alpha</code> in the <code>ns</code> form:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(ns my-ns.my-test
  (:require [clojure.spec.gen.alpha :as gen]))</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>gen</code> function can be used to obtain the generator for any spec.</p>
</div>
<div class="paragraph">
<p>Once you have obtained a generator with <code>gen</code>, there are several ways to use it.
You can generate a single sample value with generate or a series of samples with sample.
Let&#8217;s see some basic examples:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(gen/generate (s/gen int?))
=&gt; -959</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(gen/sample (s/gen string?))
=&gt; ("" "" "" "" "8" "W" "" "G74SmCm" "K9sL9" "82vC")</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(gen/sample (s/gen #{:club :diamond :heart :spade}))
=&gt; (:heart :diamond :heart :heart :heart :diamond :spade :spade :spade :club)</pre>
</div>
</div>
<div class="paragraph">
<p>What about generating a random player in our card game?</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(gen/generate (s/gen ::player))
=&gt; {:spec.examples.guide/name "sAt8r6t",
    :spec.examples.guide/score 233843,
    :spec.examples.guide/hand ([8 :spade] [5 :heart] [9 :club] [3 :heart])}</pre>
</div>
</div>
<div class="paragraph">
<p>We can even generate an entire game:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(gen/generate (s/gen ::game))</pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s useful to spec (and generate) values in a range.
For example, in the case of a range of integer values, use <code>int-in</code> to spec a range:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(s/def ::roll (s/int-in 0 11))
(gen/sample (s/gen ::roll))
=&gt; (1 0 0 3 1 7 10 1 5 0)</pre>
</div>
</div>
<div class="paragraph">
<p>Spec also includes <code>inst-in</code> for a range of Dates, and <code>double-in</code> for double ranges.</p>
</div>
<div class="paragraph">
<p>To learn more about generators, read the test.check tutorial <a href="https://clojure.github.io/test.check/intro.html" class="bare">https://clojure.github.io/test.check/intro.html</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_instrumentation_and_testing">11.10. Instrumentation and Testing</h3>
<div class="paragraph">
<p>Spec provides a set of development and testing functionality in the clojure.spec.test.alpha namespace, which we can include with:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(ns my-ns.core
  (:require [clojure.spec.test.alpha :as stest]))</pre>
</div>
</div>
<div class="paragraph">
<p>Instrumentation validates that the :args spec is being invoked on instrumented functions and thus provides validation for external uses of a function.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn ranged-rand
  "Returns random int in range start &lt;= rand &lt; end"
  [start end]
  (+ start (long (rand (- end start)))))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(stest/instrument `ranged-rand)</pre>
</div>
</div>
<div class="paragraph">
<p>Instrument takes a fully-qualified symbol so we use <code>`</code> here to resolve it in the context of the current namespace.
If the function is invoked with args that do not conform with the <code>:args</code> spec you will see an error like this:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(ranged-rand 8 5)
=&gt; CompilerException clojure.lang.ExceptionInfo: Call to #'spec.examples.guide/ranged-rand did not conform to spec</pre>
</div>
</div>
<div class="paragraph">
<p>Instrumentation can be turned off using the complementary function unstrument.
Instrumentation is useful at both development time and during testing to discover errors in calling code.
It is not recommended to use instrumentation in production due to the overhead involved with checking args specs.</p>
</div>
<div class="paragraph">
<p>We mentioned earlier that <code>clojure.spec.test.alpha</code> provides tools for automatically testing functions.
When functions have specs, we can use check, to automatically generate tests that check the function using the specs.</p>
</div>
<div class="paragraph">
<p><code>check</code> will generate arguments based on the <code>:args</code> spec for a function, invoke the function, and check that the <code>:ret</code> and <code>:fn</code> specs were satisfied.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(ns my-ns.core
  (:require [clojure.spec.test.alpha :as stest]))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(stest/check `ranged-rand)
=&gt; ({:spec #object[clojure.spec.alpha$fspec_impl ...],
     :clojure.spec.test.check/ret {:result true, :num-tests 1000, :seed 1466805740290},
     :sym spec.examples.guide/ranged-rand,
     :result true})</pre>
</div>
</div>
<div class="paragraph">
<p>A keen observer will notice that <code>ranged-rand</code> contains a subtle bug.
If the difference between start and end is very large (larger than is representable by <code>Long/MAX_VALUE</code>), then <code>ranged-rand</code> will produce an <code>IntegerOverflowException</code>.
If you run check several times you will eventually cause this case to occur.</p>
</div>
<div class="paragraph">
<p><code>check</code> also takes a number of options that can be passed to <code>test.check</code> to influence the test run, as well as the option to override generators for parts of the spec, by either name or path.</p>
</div>
<div class="paragraph">
<p>Imagine instead that we made an error in the <code>ranged-rand</code> code and swapped start and end:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">(defn ranged-rand  </dt>
<dd>
<p>BROKEN!
"Returns random int in range start &#8656; rand &lt; end"
[start end]
(+ start (long (rand (- start end)))))</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>This broken function will still create random integers, just not in the expected range.
Our <code>:fn</code> spec will detect the problem when checking the var:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(stest/abbrev-result (first (stest/check `ranged-rand)))
=&gt; ({...
     :result {...
              :clojure.spec.alpha/failure :test-failed}}</pre>
</div>
</div>
<div class="paragraph">
<p><code>check</code> has reported an error in the <code>:fn</code> spec.
We can see the arguments passed were <code>-3</code> and <code>0</code> and the return value was <code>-5</code>, which is out of the expected range.</p>
</div>
<div class="paragraph">
<p>To test all of the spec&#8217;ed functions in a namespace (or multiple namespaces), use enumerate-namespace to generate the set of symbols naming vars in the namespace:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(-&gt; (stest/enumerate-namespace 'user) stest/check)</pre>
</div>
</div>
<div class="paragraph">
<p>And you can check all of the spec&#8217;ed functions by calling <code>stest/check</code> without any arguments.</p>
</div>
<div class="paragraph">
<p>While both instrument (for enabling <code>:args</code> checking) and check (for generating tests of a function) are useful tools, they can be combined to provide even deeper levels of test coverage.</p>
</div>
<div class="paragraph">
<p>instrument takes a number of options for changing the behavior of instrumented functions, including support for swapping in alternate (narrower) specs, stubbing functions (by using the <code>:ret</code> spec to generate results), or replacing functions with an alternate implementation.</p>
</div>
<div class="paragraph">
<p>Consider the case where we have a low-level function that invokes a remote service and a higher-level function that calls it.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn invoke-service [service request])</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn run-query [service query]
  (let [{::keys [result error]} (invoke-service service
                                  {::query query})]
    (or result error)))</pre>
</div>
</div>
<div class="paragraph">
<p>We can spec these functions using the following specs:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(s/def ::query string?)
(s/def ::request (s/keys :req [::query]))
(s/def ::result (s/coll-of string? :gen-max 3))
(s/def ::error int?)
(s/def ::response (s/or :ok (s/keys :req [::result])
                        :err (s/keys :req [::error])))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(s/fdef invoke-service
  :args (s/cat :service any? :request ::request)
  :ret ::response)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(s/fdef run-query
  :args (s/cat :service any? :query string?)
  :ret (s/or :ok ::result :err ::error))</pre>
</div>
</div>
<div class="paragraph">
<p>And then we want to test the behavior of run-query while stubbing out invoke-service with instrument so that the remote service is not invoked:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(stest/instrument `invoke-service {:stub #{`invoke-service}})
=&gt; [spec.examples.guide/invoke-service]</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(invoke-service nil {::query "test"})
=&gt; #:spec.examples.guide{:error -11}</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(invoke-service nil {::query "test"})
=&gt; #:spec.examples.guide{:result ["kq0H4yv08pLl4QkVH8" "in6gH64gI0ARefv3k9Z5Fi23720gc"]}</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(stest/summarize-results (stest/check `run-query))
=&gt; {:total 1, :check-passed 1}</pre>
</div>
</div>
<div class="paragraph">
<p>The first call here instruments and stubs <code>invoke-service</code>.
The second and third calls demonstrate that calls to <code>invoke-service</code> now return generated results (rather than hitting a service).
Finally, we can use check on the higher level function to test that it behaves properly based on the generated stub results returned from <code>invoke-service</code>.</p>
</div>
<div class="paragraph">
<p>There is even more to spec! Once you are comfortable with the basics you can learn more at <a href="https://clojure.org/guides/spec" class="bare">https://clojure.org/guides/spec</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_interacting_with_a_database">12. Interacting with a Database</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
You can have data without information, but you cannot have information without data.
</blockquote>
<div class="attribution">
&#8212; Daniel Keys Moran
</div>
</div>
<div class="sect2">
<h3 id="_intro_to_clojure_java_jdbc">12.1. Intro to clojure.java.jdbc</h3>
<div class="paragraph">
<p>Database persistence is important for many applications.
We can use clojure.java.jdbc to interact with a database.</p>
</div>
<div class="paragraph">
<p>To start, create a new project</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ lein new messenger</pre>
</div>
</div>
<div class="paragraph">
<p>and add dependencies to your <code>project.clj</code> file:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[org.clojure/java.jdbc "0.7.5"]
[hsqldb/hsqldb "1.8.0.10"]</pre>
</div>
</div>
<div class="paragraph">
<p>Note that we need the driver we plan to use to connect to a database.
In this case we are using an in memory HSQL database.</p>
</div>
<div class="paragraph">
<p>In the Clojure project we require jdbc, and set up a db connection url.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(ns messenger.core
  (:require [clojure.java.jdbc :as jdbc]))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(def db "jdbc:hsqldb:mem:testdb")</pre>
</div>
</div>
<div class="paragraph">
<p>Now we are all set to start doing queries.</p>
</div>
</div>
<div class="sect2">
<h3 id="_inserting_updating_and_retrieving_data">12.2. Inserting, updating and retrieving data</h3>
<div class="paragraph">
<p>First we will create a table called testing inside the database with a text field named data, and then insert some rows.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(jdbc/execute! db
  "create table messages (message varchar(1024))")</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(jdbc/insert-multi! db :messages
                    [{:message "Hello World"}
                     {:message "How now?"}])</pre>
</div>
</div>
<div class="paragraph">
<p>And we can query the data back:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(jdbc/query db ["select * from messages"])
=&gt; ({:message "Hello World"}
    {:message "How now?"})</pre>
</div>
</div>
<div class="paragraph">
<p>To selectively delete some data:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(jdbc/delete! db :messages ["message like '%World%'"])</pre>
</div>
</div>
<div class="paragraph">
<p>And now there is only one row remaining.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(jdbc/query db ["select * from messages"])
=&gt; ({:message "Hello World"})</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s add some more data&#8230;&#8203;</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(jdbc/insert-multi! db :messages
                [{:message "Nobody panic!!!"}
                 {:message "What in the world?"}
                 {:message "All is well."}])</pre>
</div>
</div>
<div class="paragraph">
<p>And now we create a function to do a parameterized query.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn search [s]
  (jdbc/query db
    ["select * from messages where message like ?" s]))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(search "%How%")
=&gt; ({:message "How now?"})</pre>
</div>
</div>
<div class="paragraph">
<p>It is important to use parameterized queries instead of string concatenation in this example because it protects us from SQL injection.
Parameters are not part of the query, so they cannot perform SQL from malicious input.</p>
</div>
<div class="paragraph">
<p>If you want to redo any steps, remember that you can always drop the table and start again.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(jdbc/execute! db "drop table messages")</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_solutions_for_sql_management">12.3. Solutions for SQL management</h3>
<div class="paragraph">
<p>HoneySQL <a href="https://github.com/jkk/honeysql" class="bare">https://github.com/jkk/honeysql</a> can be used to build SQL statements from data structures.
This is useful when you have to programmatically combine clauses to produce a final SQL statement.
For example if the user can check a checkbox to enable an additional clause in a search.
In such cases it is more convenient to use Clojure&#8217;s capabilities for manipulating data structures.
However if you do not need to do such manipulation, I recommend using plain old SQL queries in their original text form, as you can run them interactively from an SQL prompt much easier that way.</p>
</div>
</div>
<div class="sect2">
<h3 id="_exercises_8">12.4. Exercises</h3>
<div class="ulist">
<ul>
<li>
<p>Create and populate a table <code>person</code> with two columns; <code>id</code>, <code>name</code>.</p>
</li>
<li>
<p>Create and populate a table <code>policy</code> with two columns; <code>id</code>, <code>name</code></p>
</li>
<li>
<p>Create and populate a table <code>person_policy</code> with two columns; <code>person_id</code>, <code>policy_id</code></p>
</li>
<li>
<p>Write a function that given a person name queries all the policies associated with them.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_answers_8">12.5. Answers</h3>
<div class="literalblock">
<div class="content">
<pre>(ns messenger.core
  (:require [clojure.java.jdbc :as jdbc]))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(def db "jdbc:hsqldb:mem:testdb")</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(jdbc/execute! db
  "create table person (id bigint, name varchar(1024))")
(jdbc/execute! db
  "create table policy (id bigint, name varchar(1024))")
(jdbc/execute! db
  "create table person_policy
  (person_id bigint, policy_id bigint)")
(jdbc/insert-multi! db :person
                    [{:id 1 :name "Sally"}
                     {:id 2 :name "Billy"}])
(jdbc/insert-multi! db :policy
                    [{:id 1 :name "Corgi Cover"}
                     {:id 2 :name "Poodle Protection"}])
(jdbc/insert-multi! db :person_policy
                    [{:person_id 1 :policy_id 1}
                     {:person_id 1 :policy_id 2}
                     {:person_id 2 :policy_id 1}])</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(defn find-policies [person-name]
  (jdbc/query db ["select a.name
                  from policy a
                  inner join person_policy b
                  on a.id = b.policy_id
                  inner join person c
                  on b.person_id = c.id
                  where c.name = ?"
                  person-name]))</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>(find-policies "Sally")
=&gt; ({:name "Corgi Cover"} {:name "Poodle Protection"})
(find-policies "Jane")
=&gt; ()
(find-policies "Billy")
=&gt; ({:name "Corgi Cover"})</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_challenge_4_corgi_cover_database">Challenge 4: Corgi Cover Database</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Sending files around is proving to be problematic.
Sometimes applications are lost or the results of the eligibility check are not communicated back to the customer.
You have been tasked with creating a central source of truth that can be queried as to what applications have been submitted and processed.</p>
</div>
<div class="sect2">
<h3 id="_part_1_set_up_the_schema">Part 1: Set up the schema</h3>
<div class="paragraph">
<p>Using the database of your choice, set up an initial database for the Corgi Cover project.
In the code, connect to the database and create the initial table required.
You can use whatever schema you like, but the first requirement is to store the applications with exactly the same data as was retrieved from the file format in Challenge 2.</p>
</div>
</div>
<div class="sect2">
<h3 id="_part_2_populate_the_data">Part 2: Populate the data</h3>
<div class="paragraph">
<p>Modify the code to store the applications as they are processed, and the result of the eligibility check.</p>
</div>
</div>
<div class="sect2">
<h3 id="_part_3_write_a_spec">Part 3: Write a spec</h3>
<div class="paragraph">
<p>Ensure that all records processed from the files meets your expectations for required fields.
Write a spec that explicitly defines what should be in the applications.
Validate the spec on the incoming records.</p>
</div>
</div>
<div class="sect2">
<h3 id="_part_4_extending_to_poodle_protection">Part 4: Extending to Poodle Protection</h3>
<div class="paragraph">
<p>Insuricorp is about to launch a new policy called “Poodle Protection”.
Soon they will be processing applications with completely new rules.
Set up a multimethod to handle “Poodle Protection” applications differently from “Corgi Cover” applications.
For now the only difference with the rules from “Corgi Cover” is that “Poodle Protection” is available in different states: California (CA), Florida (FL), Wyoming (WY), and Hawaii (HI).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_further_reading">13. Further reading</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Writing Clojure code requires more thinking and less typing than other languages.
Don&#8217;t feel frustrated if the code comes slowly at first.
Being a great programmer requires thinking.
You will only reach your true potential expressing code in ways that empower you rather than constrain you.</p>
</div>
<div class="paragraph">
<p>Further exercises:	<a href="https://www.4clojure.com" class="bare">https://www.4clojure.com</a></p>
</div>
<div class="paragraph">
<p>Clojure for Java Programmers - Rich Hickey</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Part 1:		<a href="https://www.youtube.com/watch?v=P76Vbsk_3J0" class="bare">https://www.youtube.com/watch?v=P76Vbsk_3J0</a></p>
</li>
<li>
<p>Part 2:		<a href="https://www.youtube.com/watch?v=hb3rurFxrZ8" class="bare">https://www.youtube.com/watch?v=hb3rurFxrZ8</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2018-06-08 00:27:51 UTC
</div>
</div>
</body>
</html>